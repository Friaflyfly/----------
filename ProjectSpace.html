<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é¡¹ç›®ååŒç©ºé—´ - å¤©åˆçŸ­å‰§å‰ªè¾‘æ¥å•å¹³å°</title>
  
  <!-- Ant Design CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@5.12.8/dist/reset.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@5.12.8/dist/antd.min.css">
  
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    .appLayout {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 200px;
      background: #fff;
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.06);
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      overflow-y: auto;
      z-index: 100;
    }

    .sidebarHeader {
      padding: 20px 16px;
      border-bottom: 1px solid #f0f0f0;
    }

    .logo {
      font-size: 18px;
      font-weight: 600;
      color: #1890ff;
      text-decoration: none;
      display: block;
    }

    .menu {
      padding: 16px 0;
    }

    .menuItem {
      display: block;
      padding: 12px 24px;
      color: #262626;
      text-decoration: none;
      font-size: 14px;
      transition: all 0.3s;
      border-left: 3px solid transparent;
    }

    .menuItem:hover {
      background-color: #f0f0f0;
      color: #1890ff;
    }

    .menuItem.active {
      background-color: #e6f7ff;
      color: #1890ff;
      border-left-color: #1890ff;
      font-weight: 500;
    }

    .menuItemIcon {
      margin-right: 8px;
      font-size: 16px;
    }

    .menuGroup {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #f0f0f0;
    }

    .menuGroupTitle {
      padding: 8px 24px;
      font-size: 12px;
      color: #8c8c8c;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }


    .mainContent {
      flex: 1;
      margin-left: 200px;
      min-height: 100vh;
      background: #f5f5f5;
    }

    .projectSpace {
      padding: 24px;
    }

    .backButton {
      margin-bottom: 16px;
    }

    .headerCard {
      margin-bottom: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .projectTitle {
      margin: 0 0 8px 0;
      font-size: 20px;
      font-weight: 600;
      color: #262626;
    }

    .orderInfo {
      color: #8c8c8c;
      font-size: 14px;
    }

    .contentCard {
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      background: #fff;
    }

    .statusTag {
      font-size: 14px;
      padding: 4px 12px;
      border-radius: 4px;
    }

    .statusTag.processing {
      background: #e6f7ff;
      color: #1890ff;
      border: 1px solid #91d5ff;
    }

    .statusTag.submitted {
      background: #f6ffed;
      color: #52c41a;
      border: 1px solid #b7eb8f;
    }

    .statusTag.approved {
      background: #f6ffed;
      color: #52c41a;
      border: 1px solid #b7eb8f;
    }

    .statusTag.revision {
      background: #fff7e6;
      color: #fa8c16;
      border: 1px solid #ffd591;
    }

    .statusTag.accepted {
      background: #f6ffed;
      color: #52c41a;
      border: 1px solid #b7eb8f;
    }

    .versionCard {
      border: 1px solid #f0f0f0;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      transition: all 0.3s;
    }

    .versionCard:hover {
      border-color: #1890ff;
      box-shadow: 0 2px 8px rgba(24, 144, 255, 0.1);
    }

    .versionCard.current {
      border-color: #52c41a;
      background: #f6ffed;
    }

    .timelineItem {
      padding: 16px;
      border-left: 2px solid #f0f0f0;
      margin-left: 20px;
      margin-bottom: 16px;
      position: relative;
    }

    .timelineItem::before {
      content: '';
      position: absolute;
      left: -6px;
      top: 20px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #1890ff;
    }

    .timelineItem.revision::before {
      background: #fa8c16;
    }

    .timelineItem.approved::before {
      background: #52c41a;
    }

    .uploadArea {
      border: 2px dashed #d9d9d9;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      background: #fafafa;
      cursor: pointer;
      transition: all 0.3s;
    }

    .uploadArea:hover {
      border-color: #1890ff;
      background: #e6f7ff;
    }

    .memberAvatar {
      margin-right: 8px;
    }

    @media (max-width: 768px) {
      .sidebar {
        display: none;
      }

      .mainContent {
        margin-left: 0;
      }

      .projectSpace {
        padding: 16px;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  
  <!-- Day.js -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
  
  <!-- Ant Design JS -->
  <script src="https://cdn.jsdelivr.net/npm/antd@5.12.8/dist/antd.min.js"></script>
  
  <!-- Babel Standalone for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const { Card, Tag, Button, Tabs, Descriptions, Space, Typography, List, Avatar, Upload, Timeline, Input, InputNumber, message, Modal, Select, Form, Alert, Table, Switch } = antd;
    const { TabPane } = Tabs;
    const { Title, Text } = Typography;
    const { TextArea } = Input;
    const { Option } = Select;

    // è·å– URL å‚æ•°
    function getUrlParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    // ä» localStorage è¯»å–æˆ–åˆå§‹åŒ–é¡¹ç›®ç©ºé—´æ•°æ®ï¼ˆåŸºäºé¡¹ç›®IDï¼‰
    function getProjectSpaceData(projectId) {
      const key = `projectSpace_${projectId}`;
      const stored = localStorage.getItem(key);
      if (stored) {
        return JSON.parse(stored);
      }
      return null;
    }

    // ä¿å­˜é¡¹ç›®ç©ºé—´æ•°æ®åˆ° localStorageï¼ˆåŸºäºé¡¹ç›®IDï¼‰
    function saveProjectSpaceData(projectId, data) {
      const key = `projectSpace_${projectId}`;
      localStorage.setItem(key, JSON.stringify(data));
    }

    // å…¼å®¹æ—§ç‰ˆæœ¬ï¼šä» localStorage è¯»å–æˆ–åˆå§‹åŒ–è®¢å•ç©ºé—´æ•°æ®ï¼ˆåŸºäºè®¢å•IDï¼‰
    function getOrderSpaceData(orderId) {
      const key = `orderSpace_${orderId}`;
      const stored = localStorage.getItem(key);
      if (stored) {
        return JSON.parse(stored);
      }
      return null;
    }

    // å…¼å®¹æ—§ç‰ˆæœ¬ï¼šä¿å­˜è®¢å•ç©ºé—´æ•°æ®åˆ° localStorageï¼ˆåŸºäºè®¢å•IDï¼‰
    // åŒæ—¶ä¿å­˜åˆ°é¡¹ç›®ç©ºé—´ï¼ˆåŸºäºé¡¹ç›®IDï¼‰ï¼Œå®ç°å¤šä¸ªè®¢å•å…±äº«
    function saveOrderSpaceData(orderId, data) {
      const key = `orderSpace_${orderId}`;
      localStorage.setItem(key, JSON.stringify(data));
      // åŒæ—¶ä¿å­˜åˆ°é¡¹ç›®ç©ºé—´ï¼ˆåŸºäºé¡¹ç›®IDï¼‰ï¼Œå®ç°å¤šä¸ªè®¢å•å…±äº«
      if (data.projectId) {
        saveProjectSpaceData(data.projectId, data);
      }
    }

    // ä¿å­˜é¡¹ç›®ç©ºé—´æ•°æ®ï¼ˆä¼˜å…ˆä½¿ç”¨æ­¤å‡½æ•°ï¼‰
    function saveSpaceData(data) {
      if (data.projectId) {
        saveProjectSpaceData(data.projectId, data);
      }
      // å¦‚æœæœ‰orderIdï¼Œä¹Ÿä¿å­˜åˆ°è®¢å•ç©ºé—´ï¼ˆå…¼å®¹ï¼‰
      if (data.orderId) {
        saveOrderSpaceData(data.orderId, data);
      }
    }

    // åˆå§‹åŒ–é¡¹ç›®ç©ºé—´æ•°æ®ï¼ˆåŸºäºé¡¹ç›®IDï¼‰
    function initProjectSpaceData(projectId, projectInfo) {
      const materialsFromProject = (projectInfo.materialPackageFiles && projectInfo.materialPackageFiles.length > 0)
        ? projectInfo.materialPackageFiles.map((f, i) => ({
            id: f.uid || String(i + 1),
            name: f.name,
            size: f.size,
            type: (f.name && f.name.split('.').pop()) || 'file',
          }))
        : [
            { id: '1', name: 'åŸå§‹ç´ æ_ç¬¬01-05é›†.zip', size: 1073741824, type: 'zip' },
            { id: '2', name: 'BGMéŸ³ä¹åº“.zip', size: 524288000, type: 'zip' },
            { id: '3', name: 'å­—å¹•æ¨¡æ¿.srt', size: 102400, type: 'srt' },
          ];
      const defaultData = {
        projectId: projectId,
        projectName: projectInfo.projectName || 'æœªå‘½åé¡¹ç›®',
        coordinator: projectInfo.coordinator || '',
        // é¡¹ç›®åŸºç¡€ä¿¡æ¯
        category: projectInfo.category || 'çŸ­å‰§',
        projectTags: projectInfo.projectTags || [],
        projectStage: projectInfo.projectStage || 'ç²¾å‰ªä¸­',
        contentGenre: projectInfo.contentGenre || '',
        difficulty: projectInfo.difficulty || 'å·¥å‚',
        participantTeam: projectInfo.participantTeam || 'çº¿ä¸Š',
        deliveryCycleDays: projectInfo.deliveryCycleDays || 7,
        takeMode: projectInfo.takeMode || 'æŠ¢å•',
        quotaTotal: projectInfo.quotaTotal || 1,
        // éœ€æ±‚ä¸ç´ æï¼ˆæ¥è‡ªé¡¹ç›®ï¼‰
        requirementText: projectInfo.requirementText || '',
        requirementAttachments: projectInfo.requirementAttachments || [],
        deliveryRequirements: projectInfo.deliveryRequirements || {},
        deliveryRequirementAttachments: projectInfo.deliveryRequirementAttachments || [],
        materialNote: projectInfo.materialNote || '',
        materialPackageFiles: projectInfo.materialPackageFiles || [],
        // è®¢å•åˆ—è¡¨ï¼ˆå¤šä¸ªè®¢å•å…±äº«ä¸€ä¸ªé¡¹ç›®ç©ºé—´ï¼‰
        orders: [],
        // é¡¹ç›®ç©ºé—´é€šç”¨æ•°æ®
        members: [
          { id: '1', name: 'å½“å‰ç”¨æˆ·', role: 'å­¦å‘˜', avatar: 'ğŸ‘¤' },
          { id: '2', name: 'æè¿è¥', role: 'è¿è¥', avatar: 'ğŸ‘¨â€ğŸ’¼' },
          { id: '3', name: 'ç‹å®¡æ ¸', role: 'å®¡æ ¸', avatar: 'ğŸ‘©â€ğŸ’¼' },
        ],
        materials: materialsFromProject,
        deliveries: [], // æ‰€æœ‰è®¢å•çš„äº¤ä»˜ç‰ˆæœ¬
        revisions: [], // æ‰€æœ‰è®¢å•çš„ä¿®æ”¹æ„è§
        messages: [], // é¡¹ç›®ç©ºé—´å†…çš„æ²Ÿé€šæ¶ˆæ¯
      };
      saveProjectSpaceData(projectId, defaultData);
      return defaultData;
    }

    // åˆå§‹åŒ–è®¢å•ç©ºé—´æ•°æ®ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰
    function initOrderSpaceData(orderId, orderInfo) {
      // ä»é¡¹ç›®æ•°æ®ä¸­è·å–åŸºç¡€ä¿¡æ¯ï¼ˆå¦‚æœorderInfoä¸­æ²¡æœ‰ï¼‰
      let projectInfo = {};
      if (orderInfo.projectId) {
        // å°è¯•ä»mockProjectsä¸­è·å–é¡¹ç›®ä¿¡æ¯
        const mockProjects = JSON.parse(localStorage.getItem('mockProjects') || '[]');
        const project = mockProjects.find(p => p.id === orderInfo.projectId);
        if (project) {
          projectInfo = {
            coordinator: project.coordinator,
            category: project.category,
            projectTags: project.projectTags || [],
            projectStage: project.projectStage,
            contentGenre: project.contentGenre,
            difficulty: project.difficulty,
            participantTeam: project.participantTeam,
            deliveryCycleDays: project.deliveryCycleDays,
            takeMode: project.takeMode,
            quotaTotal: project.quotaTotal,
          };
        }
      }
      
      const defaultData = {
        orderId: orderId,
        projectId: orderInfo.projectId,
        projectName: orderInfo.projectName,
        coordinator: projectInfo.coordinator || orderInfo.coordinator || '',
        taker: orderInfo.taker || 'å½“å‰ç”¨æˆ·',
        takerRole: orderInfo.takerRole || 'å‰ªè¾‘å¸ˆ',
        // é¡¹ç›®åŸºç¡€ä¿¡æ¯
        projectStage: projectInfo.projectStage || 'ç²¾å‰ªä¸­',
        category: projectInfo.category || orderInfo.category || 'çŸ­å‰§',
        projectTags: projectInfo.projectTags || orderInfo.projectTags || [],
        contentGenre: projectInfo.contentGenre || orderInfo.contentGenre || '',
        difficulty: projectInfo.difficulty || orderInfo.difficulty || 'å·¥å‚',
        participantTeam: projectInfo.participantTeam || orderInfo.participantTeam || 'çº¿ä¸Š',
        deliveryCycleDays: projectInfo.deliveryCycleDays || orderInfo.deliveryCycleDays || 7,
        takeMode: projectInfo.takeMode || orderInfo.takeMode || 'æŠ¢å•',
        quotaTotal: projectInfo.quotaTotal || orderInfo.quotaTotal || 1,
        // è®¢å•ä¿¡æ¯
        status: orderInfo.status || 'InProgress',
        takeTime: orderInfo.takeTime,
        dueTime: orderInfo.dueTime,
        unitPrice: orderInfo.unitPrice,
        episodeCount: orderInfo.episodeCount,
        members: [
          { id: '1', name: 'å½“å‰ç”¨æˆ·', role: 'å­¦å‘˜', avatar: 'ğŸ‘¤' },
          { id: '2', name: 'æè¿è¥', role: 'è¿è¥', avatar: 'ğŸ‘¨â€ğŸ’¼' },
          { id: '3', name: 'ç‹å®¡æ ¸', role: 'å®¡æ ¸', avatar: 'ğŸ‘©â€ğŸ’¼' },
        ],
        materials: [
          { id: '1', name: 'åŸå§‹ç´ æ_ç¬¬01-05é›†.zip', size: 1073741824, type: 'zip' },
          { id: '2', name: 'BGMéŸ³ä¹åº“.zip', size: 524288000, type: 'zip' },
          { id: '3', name: 'å­—å¹•æ¨¡æ¿.srt', size: 102400, type: 'srt' },
        ],
        deliveries: [],
        revisions: [],
        messages: [],
      };
      saveOrderSpaceData(orderId, defaultData);
      return defaultData;
    }

    // æ›´æ–°è®¢å•çŠ¶æ€
    function updateOrderStatus(orderId, newStatus) {
      const orders = JSON.parse(localStorage.getItem('currentOrders') || '[]');
      const orderIndex = orders.findIndex(o => o.orderId === orderId || o.id === orderId);
      if (orderIndex !== -1) {
        orders[orderIndex].status = newStatus;
        localStorage.setItem('currentOrders', JSON.stringify(orders));
        
        // åŒæ—¶æ›´æ–°é¡¹ç›®ç©ºé—´æ•°æ®ï¼ˆåŸºäºé¡¹ç›®IDï¼‰
        const order = orders[orderIndex];
        if (order.projectId) {
          const projectSpaceData = getProjectSpaceData(order.projectId);
          if (projectSpaceData) {
            // æ›´æ–°é¡¹ç›®ç©ºé—´ä¸­è¯¥è®¢å•çš„çŠ¶æ€
            if (!projectSpaceData.orders) {
              projectSpaceData.orders = [];
            }
            const orderInSpace = projectSpaceData.orders.find(o => o.orderId === orderId || o.id === orderId);
            if (orderInSpace) {
              orderInSpace.status = newStatus;
            } else {
              projectSpaceData.orders.push({ ...order, status: newStatus });
            }
            saveProjectSpaceData(order.projectId, projectSpaceData);
          }
        }
      }
      
      // å…¼å®¹æ—§ç‰ˆæœ¬ï¼šåŒæ—¶æ›´æ–°è®¢å•ç©ºé—´æ•°æ®
      const spaceData = getOrderSpaceData(orderId);
      if (spaceData) {
        spaceData.status = newStatus;
        saveOrderSpaceData(orderId, spaceData);
      }
    }

    const ProjectSpace = () => {
      const [activeTab, setActiveTab] = useState('overview');
      const [orderData, setOrderData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [uploadModalVisible, setUploadModalVisible] = useState(false);
      const [changeNote, setChangeNote] = useState('');
      const [episodeNumber, setEpisodeNumber] = useState(1);
      const [messageContent, setMessageContent] = useState('');
      const [revisionForm] = Form.useForm();
      const [revisionModalVisible, setRevisionModalVisible] = useState(false);
      const [selectedVersion, setSelectedVersion] = useState('');
      const [messageImages, setMessageImages] = useState([]);
      const [amountAdjustModalVisible, setAmountAdjustModalVisible] = useState(false);
      const [amountAdjustEditingRecord, setAmountAdjustEditingRecord] = useState(null);
      const [amountAdjustEditingValue, setAmountAdjustEditingValue] = useState(0);
      const [amountAdjustReason, setAmountAdjustReason] = useState('');
      const [deliveryEpisodeFilter, setDeliveryEpisodeFilter] = useState(null); // null=å…¨éƒ¨, 1-20=è¯¥é›†
      const [addMemberModalVisible, setAddMemberModalVisible] = useState(false);
      const [newMemberName, setNewMemberName] = useState('');
      const [newMemberRole, setNewMemberRole] = useState('å­¦å‘˜');
      const [newMemberAvatar, setNewMemberAvatar] = useState('ğŸ‘¤');
      const orderId = getUrlParam('orderId');
      const projectId = getUrlParam('projectId');

      useEffect(() => {
        // æ ¹æ®ä¸šåŠ¡é€»è¾‘ï¼šä¸€ä¸ªé¡¹ç›®IDå¯¹åº”ä¸€ä¸ªé¡¹ç›®ç©ºé—´ï¼Œå¤šä¸ªè®¢å•å…±äº«ä¸€ä¸ªé¡¹ç›®ç©ºé—´
        // ä¼˜å…ˆä½¿ç”¨projectIdè®¿é—®é¡¹ç›®ç©ºé—´
        if (!projectId && !orderId) {
          setLoading(false);
          return;
        }

        let spaceData = null;
        let orderInfo = null;

        // ä¼˜å…ˆåŸºäºprojectIdè·å–é¡¹ç›®ç©ºé—´
        if (projectId) {
          spaceData = getProjectSpaceData(projectId);
          
          // å¦‚æœé¡¹ç›®ç©ºé—´ä¸å­˜åœ¨ï¼Œå°è¯•ä»é¡¹ç›®æ•°æ®åˆå§‹åŒ–
          if (!spaceData) {
            // å°è¯•ä»adminProjectsæˆ–mockProjectsè·å–é¡¹ç›®ä¿¡æ¯
            const adminProjects = JSON.parse(localStorage.getItem('adminProjects') || '[]');
            const mockProjects = JSON.parse(localStorage.getItem('mockProjects') || '[]');
            const projectInfo = adminProjects.find(p => p.id == projectId) || 
                               mockProjects.find(p => p.id == projectId);
            
            if (projectInfo) {
              spaceData = initProjectSpaceData(projectId, projectInfo);
            } else {
              // å¦‚æœæ‰¾ä¸åˆ°é¡¹ç›®ä¿¡æ¯ï¼Œä½†æœ‰orderIdï¼Œä½¿ç”¨è®¢å•ä¿¡æ¯åˆå§‹åŒ–
              if (orderId) {
                const orders = JSON.parse(localStorage.getItem('currentOrders') || '[]');
                orderInfo = orders.find(o => o.orderId === orderId || o.id === orderId);
                if (orderInfo && orderInfo.projectId == projectId) {
                  // ä½¿ç”¨è®¢å•ä¿¡æ¯åˆå§‹åŒ–é¡¹ç›®ç©ºé—´
                  const tempSpaceData = initOrderSpaceData(orderId, orderInfo);
                  // è½¬æ¢ä¸ºé¡¹ç›®ç©ºé—´æ ¼å¼å¹¶ä¿å­˜
                  spaceData = {
                    ...tempSpaceData,
                    projectId: projectId,
                    orders: [orderInfo],
                  };
                  saveProjectSpaceData(projectId, spaceData);
                }
              }
            }
          }
        }

        // å¦‚æœæ²¡æœ‰projectIdä½†æœ‰orderIdï¼Œä½¿ç”¨æ—§é€»è¾‘ï¼ˆå‘åå…¼å®¹ï¼‰
        if (!spaceData && orderId) {
          const orders = JSON.parse(localStorage.getItem('currentOrders') || '[]');
          orderInfo = orders.find(o => o.orderId === orderId || o.id === orderId);

          if (!orderInfo) {
            setLoading(false);
            return;
          }

          // å°è¯•ä»é¡¹ç›®ç©ºé—´è·å–ï¼ˆå¦‚æœè®¢å•çš„projectIdå¯¹åº”çš„é¡¹ç›®ç©ºé—´å·²å­˜åœ¨ï¼‰
          if (orderInfo.projectId) {
            spaceData = getProjectSpaceData(orderInfo.projectId);
          }

          // å¦‚æœé¡¹ç›®ç©ºé—´ä¸å­˜åœ¨ï¼Œä½¿ç”¨è®¢å•ç©ºé—´æ•°æ®ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰
          if (!spaceData) {
            spaceData = getOrderSpaceData(orderId);
            if (!spaceData) {
              spaceData = initOrderSpaceData(orderId, orderInfo);
            }
            // å°†è®¢å•ç©ºé—´æ•°æ®åŒæ­¥åˆ°é¡¹ç›®ç©ºé—´
            if (orderInfo.projectId && spaceData) {
              saveProjectSpaceData(orderInfo.projectId, spaceData);
            }
          }
        }

        if (!spaceData) {
          setLoading(false);
          return;
        }

        // ç¡®ä¿æ‰€æœ‰å¿…éœ€çš„æ•°ç»„å­—æ®µéƒ½å­˜åœ¨ï¼Œé¿å… undefined
        if (spaceData) {
          if (!Array.isArray(spaceData.deliveries)) spaceData.deliveries = [];
          const isOldMock = spaceData.deliveries.length === 3 && spaceData.deliveries.every(d => d.id && String(d.id).startsWith('delivery_mock_'));
          if (spaceData.deliveries.length === 0 || isOldMock) {
            const pn = spaceData.projectName || 'æœªå‘½åé¡¹ç›®';
            spaceData.deliveries = [
              { id: 'delivery_mock_1', version: 'V1-1', episodeNumber: 1, episodeVersion: 1, fileName: `${pn}_V1-1.zip`, uploadTime: dayjs().subtract(6, 'day').format('YYYY-MM-DD HH:mm:ss'), uploader: 'å½“å‰ç”¨æˆ·', changeNote: 'ç¬¬1é›†åˆå‰ªå®Œæˆï¼Œå·²æŒ‰åˆ†é•œå®Œæˆå‰ªè¾‘ä¸è°ƒè‰²', status: 'Approved', fileSize: 268435456, isFinalized: true },
              { id: 'delivery_mock_1b', version: 'V1-2', episodeNumber: 1, episodeVersion: 2, fileName: `${pn}_V1-2.zip`, uploadTime: dayjs().subtract(5, 'day').format('YYYY-MM-DD HH:mm:ss'), uploader: 'å½“å‰ç”¨æˆ·', changeNote: 'ç¬¬1é›†ç²¾ä¿®ç‰ˆï¼Œè¡¥é•œå¤´ä¸è°ƒè‰²', status: 'Approved', fileSize: 272629760, isFinalized: true },
              { id: 'delivery_mock_2', version: 'V2-1', episodeNumber: 2, episodeVersion: 1, fileName: `${pn}_V2-1.zip`, uploadTime: dayjs().subtract(4, 'day').format('YYYY-MM-DD HH:mm:ss'), uploader: 'å½“å‰ç”¨æˆ·', changeNote: 'ç¬¬2é›†ç¬¬ä¸€ç‰ˆæäº¤ï¼Œè¯·å®¡æ ¸', status: 'NeedRevision', fileSize: 314572800, isFinalized: false },
              { id: 'delivery_mock_3', version: 'V2-2', episodeNumber: 2, episodeVersion: 2, fileName: `${pn}_V2-2.zip`, uploadTime: dayjs().subtract(2, 'day').format('YYYY-MM-DD HH:mm:ss'), uploader: 'å½“å‰ç”¨æˆ·', changeNote: 'ç¬¬2é›†æŒ‰ä¿®æ”¹æ„è§è°ƒæ•´åé‡æ–°æäº¤ï¼ˆç‰‡å¤´å­—å¹•å·²å»¶é•¿è‡³3ç§’ï¼‰', status: 'Submitted', fileSize: 318767104, isFinalized: false },
              { id: 'delivery_mock_4', version: 'V3-1', episodeNumber: 3, episodeVersion: 1, fileName: `${pn}_V3-1.zip`, uploadTime: dayjs().subtract(1, 'day').format('YYYY-MM-DD HH:mm:ss'), uploader: 'å½“å‰ç”¨æˆ·', changeNote: 'ç¬¬3é›†åˆå‰ªå®Œæˆï¼Œå¾…å®¡æ ¸', status: 'Submitted', fileSize: 293601280, isFinalized: false },
            ];
          }
          spaceData.deliveries.forEach(d => { if (d.isFinalized === undefined) d.isFinalized = false; });
          if (!Array.isArray(spaceData.revisions)) spaceData.revisions = [];
          if (spaceData.revisions.length === 0 && spaceData.deliveries.some(d => d.version === 'V2-1')) {
            spaceData.revisions = [
              { id: 'rev_mock_1', version: 'V2-1', type: 'revision', reason: 'ç‰‡å¤´å­—å¹•æ—¶é•¿åçŸ­', content: 'ç‰‡å¤´å­—å¹•éœ€å»¶é•¿è‡³ 3 ç§’ï¼Œä¸æ ·ç‰‡ä¸€è‡´ï¼›ç‰‡å°¾ç½²åé¡ºåºè¯·æŒ‰åˆåŒè°ƒæ•´', reviewer: 'ç‹å®¡æ ¸', reviewTime: dayjs().subtract(3, 'day').format('YYYY-MM-DD HH:mm:ss') },
            ];
          }
          if (!Array.isArray(spaceData.members)) {
            spaceData.members = [
              { id: '1', name: 'å½“å‰ç”¨æˆ·', role: 'å­¦å‘˜', avatar: 'ğŸ‘¤' },
              { id: '2', name: 'æè¿è¥', role: 'è¿è¥', avatar: 'ğŸ‘¨â€ğŸ’¼' },
              { id: '3', name: 'ç‹å®¡æ ¸', role: 'å®¡æ ¸', avatar: 'ğŸ‘©â€ğŸ’¼' },
            ];
          }
          if (!Array.isArray(spaceData.materials)) {
            spaceData.materials = [
              { id: '1', name: 'åŸå§‹ç´ æ_ç¬¬01-05é›†.zip', size: 1073741824, type: 'zip' },
              { id: '2', name: 'BGMéŸ³ä¹åº“.zip', size: 524288000, type: 'zip' },
              { id: '3', name: 'å­—å¹•æ¨¡æ¿.srt', size: 102400, type: 'srt' },
            ];
          }
          if (!Array.isArray(spaceData.messages)) spaceData.messages = [];
          if (!Array.isArray(spaceData.projectTags)) spaceData.projectTags = [];
          if (!Array.isArray(spaceData.orders)) spaceData.orders = [];
          if (spaceData.orders.length === 0 && spaceData.projectName) {
            spaceData.orders = [
              { orderId: 'ORD_MOCK_01', taker: 'å­¦å‘˜A', takerRole: 'å‰ªè¾‘å¸ˆ', episodeCount: 5, unitPrice: 1000, amountAdjust: 0, amountAdjustReason: '', dueTime: spaceData.dueTime || dayjs().add(7, 'day').format('YYYY-MM-DD HH:mm:ss') },
              { orderId: 'ORD_MOCK_02', taker: 'å­¦å‘˜B', takerRole: 'å‰ªè¾‘å¸ˆ', episodeCount: 3, unitPrice: 800, amountAdjust: -50, amountAdjustReason: 'å»¶æœŸäº¤ä»˜æ‰£æ¬¾', dueTime: spaceData.dueTime || dayjs().add(5, 'day').format('YYYY-MM-DD HH:mm:ss') },
              { orderId: 'ORD_MOCK_03', taker: 'å½“å‰ç”¨æˆ·', takerRole: 'å‰ªè¾‘å¸ˆ', episodeCount: 2, unitPrice: 1200, amountAdjust: 100, amountAdjustReason: 'åŠ æ€¥å¥–åŠ±', dueTime: spaceData.dueTime || dayjs().add(3, 'day').format('YYYY-MM-DD HH:mm:ss') },
            ];
          }
          if (spaceData.amountAdjust == null) spaceData.amountAdjust = 0;
          
          // å¦‚æœæœ‰è®¢å•ä¿¡æ¯ï¼ŒåŒæ­¥è®¢å•çŠ¶æ€å’Œé¡¹ç›®åŸºç¡€ä¿¡æ¯
          if (orderInfo) {
            spaceData.status = orderInfo.status || spaceData.status || 'InProgress';
            if (orderInfo.taker != null) spaceData.taker = orderInfo.taker;
            if (orderInfo.takerRole != null) spaceData.takerRole = orderInfo.takerRole;
            if (orderId) spaceData.orderId = orderId;
            if (orderInfo.category) spaceData.category = orderInfo.category;
            if (orderInfo.projectTags) spaceData.projectTags = orderInfo.projectTags;
            if (orderInfo.contentGenre) spaceData.contentGenre = orderInfo.contentGenre;
            if (orderInfo.difficulty) spaceData.difficulty = orderInfo.difficulty;
            if (orderInfo.participantTeam) spaceData.participantTeam = orderInfo.participantTeam;
            if (orderInfo.deliveryCycleDays) spaceData.deliveryCycleDays = orderInfo.deliveryCycleDays;
            if (orderInfo.takeMode) spaceData.takeMode = orderInfo.takeMode;
            if (orderInfo.quotaTotal) spaceData.quotaTotal = orderInfo.quotaTotal;
            if (orderInfo.unitPrice != null) spaceData.unitPrice = orderInfo.unitPrice;
            if (orderInfo.episodeCount != null) spaceData.episodeCount = orderInfo.episodeCount;
            
            // ç¡®ä¿é¡¹ç›®IDå’Œåç§°å­˜åœ¨
            if (!spaceData.projectId) spaceData.projectId = orderInfo.projectId;
            if (!spaceData.projectName) spaceData.projectName = orderInfo.projectName;
            
            // å°†è®¢å•ä¿¡æ¯æ·»åŠ åˆ°é¡¹ç›®ç©ºé—´çš„è®¢å•åˆ—è¡¨
            if (orderId && spaceData.orders) {
              const existingOrder = spaceData.orders.find(o => o.orderId === orderId || o.id === orderId);
              if (!existingOrder) {
                spaceData.orders.push(orderInfo);
              }
            }
          }
          
          // ç¡®ä¿é¡¹ç›®IDå­˜åœ¨
          if (!spaceData.projectId && projectId) {
            spaceData.projectId = projectId;
          }

          // ä» adminProjects æˆ– mockProjects åˆå¹¶éœ€æ±‚ä¸ç´ æï¼ˆé¡¹ç›®ç©ºé—´æœªå­˜æ—¶ç”¨é¡¹ç›®æ•°æ®è¡¥å…¨ï¼›æ”¯æŒ id ä¸ºæ•°å­—æˆ–å­—ç¬¦ä¸²ï¼‰
          const pid = spaceData.projectId || projectId;
          if (pid != null && pid !== '') {
            const adminProjects = JSON.parse(localStorage.getItem('adminProjects') || '[]');
            const mockProjects = JSON.parse(localStorage.getItem('mockProjects') || '[]');
            const project = adminProjects.find(p => p.id == pid) || mockProjects.find(p => p.id == pid);
            if (project) {
              if (project.coordinator != null) spaceData.coordinator = project.coordinator;
              if (project.city != null) spaceData.city = project.city;
              if (project.projectStatusL1 != null) spaceData.projectStatusL1 = project.projectStatusL1;
              if (project.projectStage != null) spaceData.projectStage = project.projectStage;
              if (project.requirementText != null) spaceData.requirementText = project.requirementText;
              if (project.requirementAttachments != null) spaceData.requirementAttachments = project.requirementAttachments;
              if (project.deliveryRequirements != null) spaceData.deliveryRequirements = project.deliveryRequirements;
              if (project.deliveryRequirementAttachments != null) spaceData.deliveryRequirementAttachments = project.deliveryRequirementAttachments;
              if (project.materialNote != null) spaceData.materialNote = project.materialNote;
              if (project.materialPackageFiles != null) spaceData.materialPackageFiles = project.materialPackageFiles;
              if (project.materialPackageFiles && project.materialPackageFiles.length > 0) {
                spaceData.materials = project.materialPackageFiles.map((f, i) => ({
                  id: f.uid || String(i + 1),
                  name: f.name,
                  size: f.size,
                  type: (f.name && f.name.split('.').pop()) || 'file',
                }));
              }
            }
          }
          
          // ä½¿ç”¨é¡¹ç›®IDä¿å­˜é¡¹ç›®ç©ºé—´ï¼ˆå¤šä¸ªè®¢å•å…±äº«ï¼‰
          if (spaceData.projectId) {
            saveProjectSpaceData(spaceData.projectId, spaceData);
          }
          // å…¼å®¹æ—§ç‰ˆæœ¬ï¼šä¹Ÿä¿å­˜è®¢å•ç©ºé—´æ•°æ®
          if (orderId) {
            saveOrderSpaceData(orderId, spaceData);
          }
        }

        // ç¡®ä¿é¡¹ç›®IDå­˜åœ¨
        if (spaceData && !spaceData.projectId && projectId) {
          spaceData.projectId = projectId;
          saveProjectSpaceData(projectId, spaceData);
        }

        setOrderData(spaceData);
        setLoading(false);
      }, [orderId, projectId]);

      const formatFileSize = (bytes) => {
        if (!bytes) return '-';
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
        if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
      };

      const getStatusText = (status) => {
        const statusMap = {
          'InProgress': 'è¿›è¡Œä¸­',
          'Submitted': 'å·²æäº¤',
          'NeedRevision': 'é€€å›ä¿®æ”¹',
          'Approved': 'å®¡æ ¸é€šè¿‡',
          'Accepted': 'å·²éªŒæ”¶',
        };
        return statusMap[status] || status;
      };

      const getStatusClass = (status) => {
        const classMap = {
          'InProgress': 'processing',
          'Submitted': 'submitted',
          'NeedRevision': 'revision',
          'Approved': 'approved',
          'Accepted': 'accepted',
        };
        return classMap[status] || '';
      };

      const formatDueTime = (dueTime) => {
        const date = dayjs(dueTime);
        const now = dayjs();
        const diff = date.diff(now, 'day');
        if (diff < 0) return 'å·²è¶…æœŸ';
        if (diff === 0) return 'ä»Šæ—¥æˆªæ­¢';
        if (diff === 1) return 'æ˜æ—¥æˆªæ­¢';
        return `${diff}å¤©åæˆªæ­¢`;
      };

      // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
      const handleUpload = (file) => {
        setUploadModalVisible(true);
        return false; // é˜»æ­¢è‡ªåŠ¨ä¸Šä¼ 
      };

      // ç¡®è®¤ä¸Šä¼ äº¤ä»˜æ–‡ä»¶ï¼ˆç‰ˆæœ¬å·ï¼šV{é›†æ•°}-{è¯¥é›†ç‰ˆæ¬¡}ï¼‰
      const handleConfirmUpload = () => {
        const ep = Number(episodeNumber) || 1;
        if (ep < 1) {
          message.warning('è¯·å¡«å†™æ­£ç¡®çš„é›†æ•°');
          return;
        }
        if (!changeNote.trim()) {
          message.warning('è¯·è¾“å…¥å˜æ›´è¯´æ˜');
          return;
        }

        const deliveries = orderData.deliveries || [];
        const sameEpisodeDeliveries = deliveries.filter((d) => Number(d.episodeNumber) === ep);
        const episodeVersion = sameEpisodeDeliveries.length + 1;
        const version = `V${ep}-${episodeVersion}`;

        const newDelivery = {
          id: `delivery_${Date.now()}`,
          version,
          episodeNumber: ep,
          episodeVersion,
          fileName: `${orderData.projectName}_${version}.zip`,
          uploadTime: dayjs().format('YYYY-MM-DD HH:mm:ss'),
          uploader: 'å½“å‰ç”¨æˆ·',
          changeNote: changeNote,
          status: 'Submitted',
          fileSize: Math.floor(Math.random() * 1000000000) + 100000000, // æ¨¡æ‹Ÿæ–‡ä»¶å¤§å°
          isFinalized: false,
        };

        const updatedData = {
          ...orderData,
          deliveries: [...orderData.deliveries, newDelivery],
          status: 'Submitted',
        };

        setOrderData(updatedData);
        saveSpaceData(updatedData);
        if (orderId) {
          updateOrderStatus(orderId, 'Submitted');
        }
        
        setUploadModalVisible(false);
        setChangeNote('');
        setEpisodeNumber(1);
        message.success('äº¤ä»˜æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼');
      };

      // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
      const handleImageUpload = (file) => {
        const isImage = file.type.startsWith('image/');
        if (!isImage) {
          message.error('åªèƒ½ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶ï¼');
          return false;
        }
        const isLt10M = file.size / 1024 / 1024 < 10;
        if (!isLt10M) {
          message.error('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 10MBï¼');
          return false;
        }
        
        // åˆ›å»ºé¢„è§ˆURL
        const reader = new FileReader();
        reader.onload = (e) => {
          const imageUrl = e.target.result;
          setMessageImages([...messageImages, {
            uid: file.uid,
            name: file.name,
            url: imageUrl,
            status: 'done',
          }]);
        };
        reader.readAsDataURL(file);
        return false; // é˜»æ­¢è‡ªåŠ¨ä¸Šä¼ 
      };

      // ç§»é™¤å›¾ç‰‡
      const handleRemoveImage = (file) => {
        setMessageImages(messageImages.filter(img => img.uid !== file.uid));
      };

      // å‘é€æ¶ˆæ¯
      const handleSendMessage = () => {
        if (!messageContent.trim() && messageImages.length === 0) {
          message.warning('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹æˆ–ä¸Šä¼ å›¾ç‰‡');
          return;
        }

        const newMessage = {
          id: `msg_${Date.now()}`,
          sender: 'å½“å‰ç”¨æˆ·',
          content: messageContent,
          images: messageImages.map(img => ({
            name: img.name,
            url: img.url,
          })),
          time: dayjs().format('YYYY-MM-DD HH:mm:ss'),
        };

        const updatedData = {
          ...orderData,
          messages: [...orderData.messages, newMessage],
        };

        setOrderData(updatedData);
        saveSpaceData(updatedData);
        setMessageContent('');
        setMessageImages([]);
        message.success('æ¶ˆæ¯å‘é€æˆåŠŸï¼');
      };

      // æ‰“å¼€æ·»åŠ ä¿®æ”¹æ„è§å¼¹çª—
      const handleOpenRevisionModal = (version) => {
        setSelectedVersion(version);
        revisionForm.setFieldsValue({ version: version });
        setRevisionModalVisible(true);
      };

      // å…³é—­ä¿®æ”¹æ„è§å¼¹çª—
      const handleCloseRevisionModal = () => {
        setRevisionModalVisible(false);
        setSelectedVersion('');
        revisionForm.resetFields();
      };

      // åˆ‡æ¢äº¤ä»˜æ˜¯å¦å®šç¨¿
      const toggleDeliveryFinalized = (delivery) => {
        const deliveries = (orderData.deliveries || []).map(d =>
          d.id === delivery.id ? { ...d, isFinalized: !d.isFinalized } : d
        );
        const updatedData = { ...orderData, deliveries };
        setOrderData(updatedData);
        saveSpaceData(updatedData);
        message.success(delivery.isFinalized ? 'å·²å–æ¶ˆå®šç¨¿' : 'å·²è®¾ä¸ºå®šç¨¿');
      };
      const setDeliveryFinalized = (delivery, value) => {
        const deliveries = (orderData.deliveries || []).map(d =>
          d.id === delivery.id ? { ...d, isFinalized: !!value } : d
        );
        const updatedData = { ...orderData, deliveries };
        setOrderData(updatedData);
        saveSpaceData(updatedData);
        message.success(value ? 'å·²è®¾ä¸ºå®šç¨¿' : 'å·²å–æ¶ˆå®šç¨¿');
      };

      // åˆ é™¤äº¤ä»˜ç‰ˆæœ¬ï¼ˆå¸¦ç¡®è®¤ï¼‰
      const handleDeleteDelivery = (delivery) => {
        Modal.confirm({
          title: 'ç¡®è®¤åˆ é™¤',
          content: `ç¡®å®šè¦åˆ é™¤ã€Œ${delivery.version}ã€è¯¥äº¤ä»˜ç‰ˆæœ¬å—ï¼Ÿåˆ é™¤åä¸å¯æ¢å¤ã€‚`,
          okText: 'åˆ é™¤',
          okType: 'danger',
          cancelText: 'å–æ¶ˆ',
          onOk: () => {
            const deliveries = (orderData.deliveries || []).filter(d => d.id !== delivery.id);
            const revisions = (orderData.revisions || []).filter(r => r.version !== delivery.version);
            const updatedData = { ...orderData, deliveries, revisions };
            setOrderData(updatedData);
            saveSpaceData(updatedData);
            message.success('å·²åˆ é™¤è¯¥äº¤ä»˜ç‰ˆæœ¬');
          },
        });
      };

      // åˆ é™¤ç©ºé—´æˆå‘˜
      const handleDeleteMember = (member) => {
        Modal.confirm({
          title: 'ç¡®è®¤åˆ é™¤æˆå‘˜',
          content: `ç¡®å®šè¦å°†ã€Œ${member.name}ã€ä»ç©ºé—´æˆå‘˜ä¸­ç§»é™¤å—ï¼Ÿ`,
          okText: 'åˆ é™¤',
          okType: 'danger',
          cancelText: 'å–æ¶ˆ',
          onOk: () => {
            const members = (orderData.members || []).filter(m => m.id !== member.id);
            const updatedData = { ...orderData, members };
            setOrderData(updatedData);
            saveSpaceData(updatedData);
            message.success('å·²ç§»é™¤è¯¥æˆå‘˜');
          },
        });
      };

      // æ·»åŠ ç©ºé—´æˆå‘˜
      const handleAddMember = () => {
        if (!newMemberName.trim()) {
          message.warning('è¯·è¾“å…¥æˆå‘˜å§“å');
          return;
        }
        const members = orderData.members || [];
        const newId = String(Math.max(0, ...members.map(m => Number(m.id) || 0)) + 1);
        const newMember = {
          id: newId,
          name: newMemberName.trim(),
          role: newMemberRole,
          avatar: newMemberAvatar,
        };
        const updatedData = { ...orderData, members: [...members, newMember] };
        setOrderData(updatedData);
        saveSpaceData(updatedData);
        setAddMemberModalVisible(false);
        setNewMemberName('');
        setNewMemberRole('å­¦å‘˜');
        setNewMemberAvatar('ğŸ‘¤');
        message.success('å·²æ·»åŠ æˆå‘˜');
      };

      // æ·»åŠ ä¿®æ”¹æ„è§ï¼ˆæ¨¡æ‹Ÿå®¡æ ¸é€€å›ï¼‰
      const handleAddRevision = (values) => {
        // ç¡®ä¿ deliveries å’Œ revisions æ˜¯æ•°ç»„
        const deliveries = orderData.deliveries || [];
        const revisions = orderData.revisions || [];
        
        // æ ¹æ®é€‰æ‹©çš„ç‰ˆæœ¬æ‰¾åˆ°å¯¹åº”çš„äº¤ä»˜è®°å½•
        const selectedDelivery = deliveries.find(d => d.version === values.version);
        if (!selectedDelivery) {
          message.error('æœªæ‰¾åˆ°å¯¹åº”çš„äº¤ä»˜ç‰ˆæœ¬');
          return;
        }

        const newRevision = {
          id: `revision_${Date.now()}`,
          version: values.version,
          type: 'revision',
          reason: values.reason,
          content: values.content,
          reviewer: 'ç‹å®¡æ ¸',
          reviewTime: dayjs().format('YYYY-MM-DD HH:mm:ss'),
        };

        // æ›´æ–°å¯¹åº”ç‰ˆæœ¬çš„çŠ¶æ€ä¸ºéœ€è¦ä¿®æ”¹ï¼ˆå¦‚æœä¹‹å‰æ˜¯å·²é€šè¿‡çŠ¶æ€ï¼Œåˆ™ä¿æŒï¼Œå…è®¸å¯¹å·²é€šè¿‡çš„ç‰ˆæœ¬ç»§ç»­æ·»åŠ æ„è§ï¼‰
        const updatedDeliveries = deliveries.map(d => 
          d.version === values.version && d.status !== 'Approved' ? { ...d, status: 'NeedRevision' } : d
        );

        const updatedData = {
          ...orderData,
          deliveries: updatedDeliveries,
          revisions: [...revisions, newRevision],
          // å¦‚æœè®¢å•çŠ¶æ€æ˜¯å·²é€šè¿‡ï¼Œæ·»åŠ ä¿®æ”¹æ„è§åä¸æ”¹å˜è®¢å•çŠ¶æ€
          status: orderData.status === 'Approved' ? orderData.status : 'NeedRevision',
        };

        setOrderData(updatedData);
        saveSpaceData(updatedData);
        if (orderData.status !== 'Approved' && orderId) {
          updateOrderStatus(orderId, 'NeedRevision');
        }
        revisionForm.resetFields();
        handleCloseRevisionModal();
        message.success('ä¿®æ”¹æ„è§å·²æ·»åŠ ');
      };

      // å®¡æ ¸é€šè¿‡
      const handleApprove = () => {
        Modal.confirm({
          title: 'ç¡®è®¤å®¡æ ¸é€šè¿‡',
          content: 'ç¡®å®šè¦å®¡æ ¸é€šè¿‡å½“å‰äº¤ä»˜ç‰ˆæœ¬å—ï¼Ÿ',
          onOk: () => {
            const deliveries = orderData.deliveries || [];
            if (deliveries.length === 0) {
              message.error('æ²¡æœ‰å¯å®¡æ ¸çš„äº¤ä»˜ç‰ˆæœ¬');
              return;
            }
            const latestDelivery = deliveries[deliveries.length - 1];
            const updatedDeliveries = deliveries.map(d => 
              d.id === latestDelivery.id ? { ...d, status: 'Approved' } : d
            );

            const newRevision = {
              id: `revision_${Date.now()}`,
              version: latestDelivery.version,
              type: 'approved',
              reason: 'å®¡æ ¸é€šè¿‡',
              content: 'äº¤ä»˜æ–‡ä»¶ç¬¦åˆè¦æ±‚ï¼Œå®¡æ ¸é€šè¿‡',
              reviewer: 'ç‹å®¡æ ¸',
              reviewTime: dayjs().format('YYYY-MM-DD HH:mm:ss'),
            };

            const updatedData = {
              ...orderData,
              deliveries: updatedDeliveries,
              revisions: [...orderData.revisions, newRevision],
              status: 'Approved',
            };

            setOrderData(updatedData);
            saveSpaceData(updatedData);
            if (orderId) {
              updateOrderStatus(orderId, 'Approved');
            }
            message.success('å®¡æ ¸é€šè¿‡ï¼');
          },
        });
      };

      // ç”³è¯·éªŒæ”¶
      const handleAccept = () => {
        if (!orderData) return;
        Modal.confirm({
          title: 'ç¡®è®¤éªŒæ”¶',
          content: 'ç¡®å®šè¦ç”³è¯·éªŒæ”¶å—ï¼ŸéªŒæ”¶åå°†è®¡å…¥æ”¶ç›Šã€‚',
          onOk: () => {
            let updatedData = { ...orderData, status: 'Accepted' };
            if (orderId && orderData.orders && orderData.orders.length > 0) {
              updatedData = {
                ...updatedData,
                orders: orderData.orders.map(o => (o.orderId === orderId || o.id === orderId) ? { ...o, status: 'Accepted' } : o),
              };
            }
            setOrderData(updatedData);
            saveSpaceData(updatedData);
            if (orderId) {
              updateOrderStatus(orderId, 'Accepted');
            }
            
            // åˆ›å»ºæ”¶ç›Šè®°å½•ï¼ˆå«å·®é¢ï¼‰ï¼šæŒ‰å½“å‰è®¢å• orderId å–è¯¥è®¢å•é‡‘é¢
            const earnings = JSON.parse(localStorage.getItem('earnings') || '[]');
            const currentOrder = orderId && orderData.orders && orderData.orders.length > 0
              ? orderData.orders.find(o => o.orderId === orderId || o.id === orderId)
              : null;
            const base = currentOrder ? (currentOrder.unitPrice * currentOrder.episodeCount) : (orderData.unitPrice * orderData.episodeCount);
            const adjust = Number(currentOrder ? currentOrder.amountAdjust : orderData.amountAdjust) || 0;
            const totalAmount = base + adjust;
            earnings.push({
              orderId: orderId,
              projectName: orderData.projectName,
              amount: totalAmount,
              acceptTime: dayjs().format('YYYY-MM-DD HH:mm:ss'),
              status: 'æœªç»“ç®—',
              settlementMonth: dayjs().format('YYYY-MM'),
            });
            localStorage.setItem('earnings', JSON.stringify(earnings));
            
            message.success('éªŒæ”¶æˆåŠŸï¼æ”¶ç›Šå·²å…¥è´¦ã€‚');
          },
        });
      };

      // ç®¡ç†å‘˜ä¿å­˜æŸè®¢å•çš„å·®é¢ï¼ˆå¿…å¡«åŸå› ç•™ç—•ï¼‰
      const handleSaveAmountAdjust = (record, newAdjust, reason) => {
        if (!orderData) return;
        const trimmed = (reason || '').trim();
        if (!trimmed) {
          message.error('è¯·å¡«å†™å·®é¢åŸå› ');
          return;
        }
        const num = Math.round(Number(newAdjust) || 0);
        const now = dayjs().format('YYYY-MM-DD HH:mm:ss');
        const orders = orderData.orders && orderData.orders.length > 0
          ? orderData.orders.map(o => (o.orderId === record.orderId || o.id === record.orderId)
              ? { ...o, amountAdjust: num, amountAdjustReason: trimmed, amountAdjustTime: now, amountAdjustBy: 'ç®¡ç†å‘˜' }
              : { ...o, amountAdjust: o.amountAdjust ?? 0 })
          : null;
        const updatedData = orders
          ? { ...orderData, orders }
          : { ...orderData, amountAdjust: num, amountAdjustReason: trimmed, amountAdjustTime: now, amountAdjustBy: 'ç®¡ç†å‘˜' };
        setOrderData(updatedData);
        saveSpaceData(updatedData);
        setAmountAdjustModalVisible(false);
        setAmountAdjustReason('');
        setAmountAdjustEditingRecord(null);
        message.success('å·®é¢å·²ä¿å­˜');
      };

      // è¡¨æ ¼æ•°æ®æºï¼šå¤šè®¢å•ç”¨ ordersï¼Œå¦åˆ™ç”¨å½“å‰ç©ºé—´é¡¶å±‚å­—æ®µ + URL çš„ orderId æ‹¼è‡³å°‘ä¸€è¡Œ
      const reviewTableDataSource = (() => {
        if (!orderData) return [];
        if (orderData.orders && orderData.orders.length > 0) {
          return orderData.orders.map(o => ({ ...o, amountAdjust: o.amountAdjust ?? 0 }));
        }
        // æœ‰é¡¹ç›®ç©ºé—´ä½†æ—  orders åˆ—è¡¨æ—¶ï¼Œç”¨ç©ºé—´é¡¶å±‚å’Œ URL å‚æ•°æ‹¼ä¸€è¡Œï¼Œä¿è¯å§‹ç»ˆæœ‰æ•°æ®å¯çœ‹
        return [{
          orderId: orderData.orderId || orderId,
          id: orderData.orderId || orderId,
          taker: orderData.taker ?? 'å½“å‰ç”¨æˆ·',
          takerRole: orderData.takerRole ?? 'å‰ªè¾‘å¸ˆ',
          episodeCount: orderData.episodeCount,
          status: orderData.status,
          unitPrice: orderData.unitPrice,
          amountAdjust: orderData.amountAdjust ?? 0,
          amountAdjustReason: orderData.amountAdjustReason,
        }];
      })();

      // å½“å‰ç”¨æˆ·æ˜¯å¦ä¸ºå­¦å‘˜ï¼ˆæ¥å•äººï¼‰ï¼šå­¦å‘˜ä¸å…è®¸çœ‹è®¢å•ç®¡ç† Tab
      const isTakerView = orderData && (
        orderData.taker === 'å½“å‰ç”¨æˆ·' ||
        (orderData.orders && orderData.orders.some(o => o.taker === 'å½“å‰ç”¨æˆ·'))
      );

      // å­¦å‘˜è¿›å…¥è®¢å• Tab æ—¶ä¸å†å¼ºåˆ¶è·³è½¬æ¦‚è§ˆï¼Œåœ¨è®¢å• Tab å†…å±•ç¤ºåªè¯»çš„å½“å‰è®¢å•ä¿¡æ¯å³å¯

      if (loading) {
        return (
          <div className="appLayout">
            <div className="sidebar">
              <div className="sidebarHeader">
                <a href="Home.html" className="logo">ğŸ¬ å¤©åˆçŸ­å‰§å¹³å°</a>
              </div>
              <nav className="menu">
                <a href="Home.html" className="menuItem">
                  <span className="menuItemIcon">ğŸ </span>
                  é¦–é¡µ
                </a>
                <a href="ProjectHall.html" className="menuItem">
                  <span className="menuItemIcon">ğŸ“‹</span>
                  æ¥å•å¤§å…
                </a>
                <a href="Leaderboard.html" className="menuItem">
                  <span className="menuItemIcon">ğŸ†</span>
                  å¤©æ¢¯æ¦œå•
                </a>
                <a href="Account.html" className="menuItem">
                  <span className="menuItemIcon">ğŸ’°</span>
                  è´¦æˆ·ä¸æ”¶ç›Š
                </a>
              </nav>
            </div>
            <div className="mainContent">
              <div style={{ textAlign: 'center', padding: '60px 20px' }}>åŠ è½½ä¸­...</div>
            </div>
          </div>
        );
      }

      if (!orderData) {
        return (
          <div className="appLayout">
            <div className="sidebar">
              <div className="sidebarHeader">
                <a href="Home.html" className="logo">ğŸ¬ å¤©åˆçŸ­å‰§å¹³å°</a>
              </div>
              <nav className="menu">
                <a href="Home.html" className="menuItem">
                  <span className="menuItemIcon">ğŸ </span>
                  é¦–é¡µ
                </a>
                <a href="ProjectHall.html" className="menuItem">
                  <span className="menuItemIcon">ğŸ“‹</span>
                  æ¥å•å¤§å…
                </a>
                <a href="Leaderboard.html" className="menuItem">
                  <span className="menuItemIcon">ğŸ†</span>
                  å¤©æ¢¯æ¦œå•
                </a>
                <a href="Account.html" className="menuItem">
                  <span className="menuItemIcon">ğŸ’°</span>
                  è´¦æˆ·ä¸æ”¶ç›Š
                </a>
              </nav>
            </div>
            <div className="mainContent">
              <div style={{ textAlign: 'center', padding: '60px 20px', color: '#ff4d4f' }}>è®¢å•ä¸å­˜åœ¨</div>
            </div>
          </div>
        );
      }

      return (
        <div className="appLayout">
          {/* å·¦ä¾§å¯¼èˆªæ  */}
          <div className="sidebar">
            <div className="sidebarHeader">
              <a href="Home.html" className="logo">ğŸ¬ å¤©åˆçŸ­å‰§å¹³å°</a>
            </div>
            <nav className="menu">
              <a href="Home.html" className="menuItem">
                <span className="menuItemIcon">ğŸ </span>
                é¦–é¡µ
              </a>
              <a href="ProjectHall.html" className="menuItem">
                <span className="menuItemIcon">ğŸ“‹</span>
                æ¥å•å¤§å…
              </a>
              <a href="ProjectHall.html?tab=leaderboard" className="menuItem">
                <span className="menuItemIcon">ğŸ†</span>
                å¤©æ¢¯æ¦œå•
              </a>
              <a href="Account.html" className="menuItem">
                <span className="menuItemIcon">ğŸ’°</span>
                è´¦æˆ·ä¸æ”¶ç›Š
              </a>
              <a href="MyProjects.html" className="menuItem">
                <span className="menuItemIcon">ğŸš€</span>
                æˆ‘çš„é¡¹ç›®
              </a>
              
              <div className="menuGroup">
                <div className="menuGroupTitle">åå°ç®¡ç†</div>
                <a href="ReviewQueue.html" className="menuItem">
                  <span className="menuItemIcon">âœ…</span>
                  ä»»åŠ¡å®¡æ ¸
                </a>
                <a href="ProjectManagement.html" className="menuItem">
                  <span className="menuItemIcon">ğŸ“‹</span>
                  é¡¹ç›®ç®¡ç†
                </a>
                <a href="StudentManagement.html" className="menuItem">
                  <span className="menuItemIcon">ğŸ‘¥</span>
                  å­¦å‘˜ç®¡ç†
                </a>
                <a href="FinanceManagement.html" className="menuItem">
                  <span className="menuItemIcon">ğŸ’°</span>
                  è´¢åŠ¡å¯¹è´¦
                </a>
                <a href="DashboardManagement.html" className="menuItem" style={{ display: 'none' }}>
                  <span className="menuItemIcon">ğŸ“Š</span>
                  æ¦œå•ä¸æ•°æ®
                </a>
                <a href="DataBoard.html" className="menuItem">
                  <span className="menuItemIcon">ğŸ“ˆ</span>
                  æ•°æ®çœ‹æ¿
                </a>
              </div>
            </nav>
          </div>

          {/* ä¸»å†…å®¹åŒº */}
          <div className="mainContent">
            <div className="projectSpace">
            <div className="backButton">
              <Button onClick={() => window.location.href = 'ProjectHall.html'}>
                â† è¿”å›æ¥å•å¤§å…
              </Button>
            </div>

            <Card className="headerCard">
              <Title level={3} className="projectTitle">{orderData.projectName}</Title>
              <div className="orderInfo">
                è®¢å•å·ï¼š{orderData.orderId} | 
                æ¥å•æ—¶é—´ï¼š{dayjs(orderData.takeTime).format('YYYY-MM-DD HH:mm:ss')} | 
                æˆªæ­¢æ—¶é—´ï¼š{dayjs(orderData.dueTime).format('YYYY-MM-DD HH:mm:ss')} 
                <span style={{ color: '#fa8c16', marginLeft: '8px' }}>
                  ({formatDueTime(orderData.dueTime)})
                </span>
              </div>
              <div style={{ marginTop: '12px' }}>
                <span className={`statusTag ${getStatusClass(orderData.status)}`}>
                  {getStatusText(orderData.status)}
                </span>
              </div>
            </Card>

            <Card className="contentCard">
              <Tabs activeKey={activeTab} onChange={setActiveTab}>
                <TabPane tab="ğŸ“Š æ¦‚è§ˆ" key="overview">
                  <Descriptions column={2} bordered style={{ marginTop: 16 }}>
                    <Descriptions.Item label="è®¢å•å·">{orderData.orderId}</Descriptions.Item>
                    <Descriptions.Item label="é¡¹ç›®åç§°">{orderData.projectName}</Descriptions.Item>
                    <Descriptions.Item label="ç»Ÿç­¹äººå‘˜">{orderData.coordinator || '-'}</Descriptions.Item>
                    <Descriptions.Item label="å†…å®¹åˆ†ç±»">
                      <Tag color="blue">{orderData.category || 'çŸ­å‰§'}</Tag>
                    </Descriptions.Item>
                    <Descriptions.Item label="é¡¹ç›®æ ‡ç­¾">
                      <Space size="small" wrap>
                        {orderData.projectTags && orderData.projectTags.length > 0 ? (
                          orderData.projectTags.map((tag, index) => (
                            <Tag key={index}>{tag}</Tag>
                          ))
                        ) : (
                          <span style={{ color: '#8c8c8c' }}>æ— </span>
                        )}
                      </Space>
                    </Descriptions.Item>
                    <Descriptions.Item label="å†…å®¹ç±»åˆ«">
                      <Tag color="purple">{orderData.contentGenre || '-'}</Tag>
                    </Descriptions.Item>
                    <Descriptions.Item label="éš¾åº¦">
                      <Tag color={orderData.difficulty === 'ç²¾å“' ? 'gold' : 'default'}>
                        {orderData.difficulty || 'å·¥å‚'}
                      </Tag>
                    </Descriptions.Item>
                    <Descriptions.Item label="å‚ä¸å›¢é˜Ÿ">
                      {orderData.participantTeam || 'çº¿ä¸Š'}
                    </Descriptions.Item>
                    <Descriptions.Item label="é¡¹ç›®çŠ¶æ€">
                      <Tag color="blue">{orderData.projectStage || 'ç²¾å‰ªä¸­'}</Tag>
                    </Descriptions.Item>
                    <Descriptions.Item label="äº¤ä»˜å‘¨æœŸ">
                      {orderData.deliveryCycleDays || 7}å¤©
                    </Descriptions.Item>
                    <Descriptions.Item label="æ¥å•æ¨¡å¼">
                      <Tag color={orderData.takeMode === 'æŠ¢å•' ? 'green' : 'orange'}>
                        {orderData.takeMode || 'æŠ¢å•'}
                      </Tag>
                    </Descriptions.Item>
                    <Descriptions.Item label="åé¢">
                      {orderData.quotaTotal || 1}äºº
                    </Descriptions.Item>
                    <Descriptions.Item label="è®¢å•çŠ¶æ€">
                      <span className={`statusTag ${getStatusClass(orderData.status)}`}>
                        {getStatusText(orderData.status)}
                      </span>
                    </Descriptions.Item>
                    <Descriptions.Item label="æ¥å•æ—¶é—´">
                      {dayjs(orderData.takeTime).format('YYYY-MM-DD HH:mm:ss')}
                    </Descriptions.Item>
                    <Descriptions.Item label="æˆªæ­¢æ—¶é—´">
                      {dayjs(orderData.dueTime).format('YYYY-MM-DD HH:mm:ss')}
                      <span style={{ color: '#fa8c16', marginLeft: '8px' }}>
                        ({formatDueTime(orderData.dueTime)})
                      </span>
                    </Descriptions.Item>
                    <Descriptions.Item label="å•ä»·">
                      Â¥{orderData.unitPrice}/é›†
                    </Descriptions.Item>
                    <Descriptions.Item label="é›†æ•°">{orderData.episodeCount}é›†</Descriptions.Item>
                    <Descriptions.Item label="æ€»é‡‘é¢">
                      <span style={{ color: '#52c41a', fontWeight: 600 }}>
                        Â¥{orderData.unitPrice * orderData.episodeCount}
                      </span>
                    </Descriptions.Item>
                    <Descriptions.Item label="ç©ºé—´æˆå‘˜" span={2}>
                      <Space wrap size="middle">
                        {(orderData.members || []).map((member) => (
                          <Space key={member.id} style={{ padding: '8px 12px', background: '#fafafa', borderRadius: 6, border: '1px solid #f0f0f0' }}>
                            <Avatar>{member.avatar}</Avatar>
                            <span>{member.name}</span>
                            <Tag>{member.role}</Tag>
                            <Button type="link" danger size="small" onClick={() => handleDeleteMember(member)} title="ç§»é™¤è¯¥æˆå‘˜">åˆ é™¤</Button>
                          </Space>
                        ))}
                        <Button type="dashed" size="small" onClick={() => setAddMemberModalVisible(true)}>+ æ·»åŠ æˆå‘˜</Button>
                      </Space>
                    </Descriptions.Item>
                  </Descriptions>
                </TabPane>

                <TabPane tab="ğŸ“‹ éœ€æ±‚ä¸ç´ æ" key="requirements">
                  <Descriptions column={1} bordered style={{ marginTop: 16 }}>
                    <Descriptions.Item label="é¡¹ç›®éœ€æ±‚ï¼ˆæ–‡æœ¬ï¼‰">
                      <div style={{ whiteSpace: 'pre-wrap', maxHeight: 300, overflow: 'auto', padding: 12, background: '#f5f5f5', borderRadius: 4 }}>
                        {orderData.requirementText || '-'}
                      </div>
                    </Descriptions.Item>
                    <Descriptions.Item label="é¡¹ç›®éœ€æ±‚ï¼ˆé™„ä»¶ï¼‰">
                      {orderData.requirementAttachments && orderData.requirementAttachments.length > 0 ? (
                        <Space direction="vertical">
                          {orderData.requirementAttachments.map((file, idx) => (
                            <div key={file.uid || idx}>
                              <Button type="link" onClick={() => message.info('ä¸‹è½½åŠŸèƒ½å¼€å‘ä¸­')}>
                                ğŸ“ {file.name}
                              </Button>
                              <span style={{ marginLeft: 8, color: '#8c8c8c', fontSize: 12 }}>
                                ({formatFileSize(file.size)})
                              </span>
                            </div>
                          ))}
                        </Space>
                      ) : '-'}
                    </Descriptions.Item>
                    <Descriptions.Item label="äº¤ä»˜è¦æ±‚">
                      {orderData.deliveryRequirements && Object.keys(orderData.deliveryRequirements).length > 0 ? (
                        <div style={{ padding: 12, background: '#fff7e6', borderRadius: 4 }}>
                          {Object.entries(orderData.deliveryRequirements).map(([key, value]) => (
                            <div key={key} style={{ marginBottom: 8 }}>
                              <Text strong>{key === 'namingRule' ? 'å‘½åè§„èŒƒ' : key === 'resolution' ? 'åˆ†è¾¨ç‡' : key === 'bitrate' ? 'ç ç‡' : key === 'subtitleRule' ? 'å­—å¹•è§„èŒƒ' : key}ï¼š</Text>
                              <span style={{ marginLeft: 8 }}>{value || '-'}</span>
                            </div>
                          ))}
                        </div>
                      ) : '-'}
                    </Descriptions.Item>
                    <Descriptions.Item label="äº¤ä»˜è¦æ±‚ï¼ˆé™„ä»¶ï¼‰">
                      {orderData.deliveryRequirementAttachments && orderData.deliveryRequirementAttachments.length > 0 ? (
                        <Space direction="vertical">
                          {orderData.deliveryRequirementAttachments.map((file, idx) => (
                            <div key={file.uid || idx}>
                              <Button type="link" onClick={() => message.info('ä¸‹è½½åŠŸèƒ½å¼€å‘ä¸­')}>
                                ğŸ“ {file.name}
                              </Button>
                              <span style={{ marginLeft: 8, color: '#8c8c8c', fontSize: 12 }}>
                                ({formatFileSize(file.size)})
                              </span>
                            </div>
                          ))}
                        </Space>
                      ) : '-'}
                    </Descriptions.Item>
                    <Descriptions.Item label="ç´ æè¯´æ˜">
                      <div style={{ whiteSpace: 'pre-wrap', maxHeight: 200, overflow: 'auto', padding: 12, background: '#f5f5f5', borderRadius: 4 }}>
                        {orderData.materialNote || '-'}
                      </div>
                    </Descriptions.Item>
                    <Descriptions.Item label="ç´ æåŒ…">
                      {orderData.materialPackageFiles && orderData.materialPackageFiles.length > 0 ? (
                        <Space direction="vertical">
                          {orderData.materialPackageFiles.map((file, idx) => (
                            <div key={file.uid || idx}>
                              <Button type="link" onClick={() => message.info('ä¸‹è½½åŠŸèƒ½å¼€å‘ä¸­')}>
                                ğŸ“¦ {file.name}
                              </Button>
                              <span style={{ marginLeft: 8, color: '#8c8c8c', fontSize: 12 }}>
                                ({formatFileSize(file.size)})
                              </span>
                            </div>
                          ))}
                        </Space>
                      ) : (orderData.materials && orderData.materials.length > 0 ? (
                        <Space direction="vertical">
                          {orderData.materials.map((file, idx) => (
                            <div key={file.id || idx}>
                              <Button type="link" onClick={() => message.info('ä¸‹è½½åŠŸèƒ½å¼€å‘ä¸­')}>
                                ğŸ“¦ {file.name}
                              </Button>
                              <span style={{ marginLeft: 8, color: '#8c8c8c', fontSize: 12 }}>
                                ({formatFileSize(file.size)})
                              </span>
                            </div>
                          ))}
                        </Space>
                      ) : '-')}
                    </Descriptions.Item>
                  </Descriptions>
                </TabPane>

                <TabPane tab="ğŸ“¤ äº¤ä»˜ä¸ä¿®æ”¹" key="deliveries">
                  <div style={{ marginTop: 16 }}>
                    {/* 1-20 é›†ç‹¬ç«‹ç­›é€‰æ¡† */}
                    <div style={{ marginBottom: 16 }}>
                      <div style={{ fontSize: 14, color: '#595959', marginBottom: 8 }}>æŒ‰é›†æ•°ç­›é€‰ï¼ˆç‚¹å‡»æ–¹æ¡†ä»…å±•ç¤ºè¯¥é›†ç‰ˆæœ¬ï¼‰</div>
                      <div style={{ display: 'flex', flexWrap: 'wrap', gap: 8, alignItems: 'center' }}>
                        <div
                          onClick={() => setDeliveryEpisodeFilter(null)}
                          style={{
                            width: 40,
                            height: 36,
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            border: '1px solid #d9d9d9',
                            borderRadius: 4,
                            cursor: 'pointer',
                            background: deliveryEpisodeFilter === null ? '#1890ff' : '#fff',
                            color: deliveryEpisodeFilter === null ? '#fff' : '#262626',
                            fontWeight: deliveryEpisodeFilter === null ? 600 : 400,
                          }}
                        >
                          å…¨éƒ¨
                        </div>
                        {[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20].map((ep) => {
                          const selected = deliveryEpisodeFilter === ep;
                          return (
                            <div
                              key={ep}
                              onClick={() => setDeliveryEpisodeFilter(ep)}
                              style={{
                                width: 40,
                                height: 36,
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                border: '1px solid #d9d9d9',
                                borderRadius: 4,
                                cursor: 'pointer',
                                background: selected ? '#1890ff' : '#fff',
                                color: selected ? '#fff' : '#262626',
                                fontWeight: selected ? 600 : 400,
                              }}
                            >
                              {ep}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                    {(() => {
                      const allDeliveries = orderData.deliveries || [];
                      const deliveriesToShow = deliveryEpisodeFilter == null
                        ? allDeliveries
                        : allDeliveries.filter((d) => Number(d.episodeNumber) === deliveryEpisodeFilter);
                      return (!deliveriesToShow.length) ? (
                        <div className="uploadArea">
                          <div style={{ fontSize: 48, marginBottom: 16 }}>ğŸ“¤</div>
                          <div style={{ fontSize: 16, color: '#8c8c8c' }}>
                            {allDeliveries.length === 0 ? 'æš‚æ— äº¤ä»˜æ–‡ä»¶' : (deliveryEpisodeFilter != null ? `ç¬¬ ${deliveryEpisodeFilter} é›†æš‚æ— ç‰ˆæœ¬` : 'æš‚æ— äº¤ä»˜æ–‡ä»¶')}
                          </div>
                        </div>
                      ) : (
                        deliveriesToShow.map((delivery) => {
                        // è·å–è¯¥ç‰ˆæœ¬å¯¹åº”çš„ä¿®æ”¹æ„è§
                        const versionRevisions = (orderData.revisions || [])
                          .filter(r => r.version === delivery.version)
                          .sort((a, b) => dayjs(a.reviewTime).valueOf() - dayjs(b.reviewTime).valueOf());
                        
                        const versionTitle = delivery.episodeNumber != null && delivery.version
                          ? `ç¬¬ ${delivery.episodeNumber} é›† Â· ${delivery.version}`
                          : (delivery.version || delivery.fileName);
                        return (
                          <div key={delivery.id} className={`versionCard ${delivery.status === 'Approved' ? 'current' : ''}`} style={{ marginBottom: 24 }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>
                              <Space>
                                <Tag color="blue">{delivery.version}</Tag>
                                <span style={{ fontWeight: 500 }}>{versionTitle}</span>
                                <span className={`statusTag ${getStatusClass(delivery.status)}`}>
                                  {getStatusText(delivery.status)}
                                </span>
                              </Space>
                              <Space>
                                <Button type="link" href="#" download title="ä¸‹è½½æœ¬ç‰ˆæœ¬">ä¸‹è½½</Button>
                                <Button 
                                  type="link" 
                                  onClick={() => handleOpenRevisionModal(delivery.version)}
                                  style={{ color: '#1890ff' }}
                                  title={`é’ˆå¯¹ ${delivery.version} æ·»åŠ ä¿®æ”¹æ„è§`}
                                >
                                  ğŸ’¬ æ·»åŠ ä¿®æ”¹æ„è§
                                </Button>
                                <Button 
                                  type="link" 
                                  danger 
                                  onClick={() => handleDeleteDelivery(delivery)}
                                  title="åˆ é™¤è¯¥äº¤ä»˜ç‰ˆæœ¬"
                                >
                                  åˆ é™¤
                                </Button>
                              </Space>
                            </div>
                            <div style={{ color: '#8c8c8c', fontSize: 12, marginBottom: 8 }}>
                              ä¸Šä¼ æ—¶é—´ï¼š{dayjs(delivery.uploadTime).format('YYYY-MM-DD HH:mm:ss')} | 
                              ä¸Šä¼ äººï¼š{delivery.uploader} | 
                              å¤§å°ï¼š{formatFileSize(delivery.fileSize)}
                            </div>
                            <div style={{ marginBottom: 8, display: 'flex', alignItems: 'center', gap: 8 }}>
                              <span style={{ fontSize: 13, color: '#595959' }}>æ˜¯å¦å®šç¨¿ï¼š</span>
                              <Switch
                                checked={!!delivery.isFinalized}
                                onChange={(checked) => setDeliveryFinalized(delivery, checked)}
                                checkedChildren="æ˜¯"
                                unCheckedChildren="å¦"
                              />
                            </div>
                            {delivery.changeNote && (
                              <div style={{ color: '#595959', fontSize: 13, marginBottom: 12 }}>
                                å˜æ›´è¯´æ˜ï¼š{delivery.changeNote}
                              </div>
                            )}
                            
                            {/* æ˜¾ç¤ºè¯¥ç‰ˆæœ¬çš„ä¿®æ”¹æ„è§ */}
                            {versionRevisions.length > 0 && (
                              <div style={{ 
                                marginTop: 16, 
                                padding: '16px', 
                                background: '#fafafa', 
                                borderRadius: '6px',
                                border: '1px solid #e8e8e8'
                              }}>
                                <div style={{ fontSize: 14, fontWeight: 600, marginBottom: 12, color: '#262626' }}>
                                  ğŸ’¬ ä¿®æ”¹æ„è§
                                </div>
                                <Timeline style={{ marginTop: 8 }}>
                                  {versionRevisions.map((revision) => (
                                    <Timeline.Item key={revision.id}>
                                      <div className={`timelineItem ${revision.type}`}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 8 }}>
                                          <Space>
                                            <Tag color={revision.type === 'approved' ? 'green' : 'orange'}>
                                              {revision.type === 'approved' ? 'å®¡æ ¸é€šè¿‡' : 'é€€å›ä¿®æ”¹'}
                                            </Tag>
                                          </Space>
                                          <span style={{ color: '#8c8c8c', fontSize: 12 }}>
                                            {dayjs(revision.reviewTime).format('YYYY-MM-DD HH:mm:ss')}
                                          </span>
                                        </div>
                                        <div style={{ marginBottom: 8 }}>
                                          <Text strong>é€€å›åŸå› ï¼š</Text>
                                          <Text>{revision.reason}</Text>
                                        </div>
                                        <div>
                                          <Text strong>ä¿®æ”¹ç‚¹ï¼š</Text>
                                          <Text>{revision.content}</Text>
                                        </div>
                                        <div style={{ marginTop: 8, color: '#8c8c8c', fontSize: 12 }}>
                                          å®¡æ ¸äººï¼š{revision.reviewer}
                                        </div>
                                      </div>
                                    </Timeline.Item>
                                  ))}
                                </Timeline>
                              </div>
                            )}
                          </div>
                        );
                      })
                      );
                    })()}
                    
                    {/* æ·»åŠ ä¿®æ”¹æ„è§å¼¹çª— */}
                    <Modal
                      title="æ·»åŠ ä¿®æ”¹æ„è§"
                      open={revisionModalVisible}
                      onCancel={handleCloseRevisionModal}
                      footer={null}
                      width={600}
                    >
                      <Form form={revisionForm} onFinish={handleAddRevision} layout="vertical">
                        <Form.Item name="version" label="ç‰ˆæœ¬" rules={[{ required: true, message: 'è¯·é€‰æ‹©ç‰ˆæœ¬' }]}>
                          <Select placeholder="è¯·é€‰æ‹©ç‰ˆæœ¬" disabled={!!selectedVersion}>
                            {(orderData.deliveries || []).map(d => (
                              <Option key={d.id} value={d.version}>
                                {d.version} - {d.fileName} 
                                {d.status === 'Approved' && <Tag color="green" style={{ marginLeft: 8 }}>å·²é€šè¿‡</Tag>}
                                {d.status === 'NeedRevision' && <Tag color="orange" style={{ marginLeft: 8 }}>éœ€ä¿®æ”¹</Tag>}
                              </Option>
                            ))}
                          </Select>
                        </Form.Item>
                        <Form.Item name="reason" label="é€€å›åŸå› " rules={[{ required: true, message: 'è¯·é€‰æ‹©é€€å›åŸå› ' }]}>
                          <Select placeholder="è¯·é€‰æ‹©é€€å›åŸå› ">
                            <Option value="ç”»é¢è´¨é‡é—®é¢˜">ç”»é¢è´¨é‡é—®é¢˜</Option>
                            <Option value="éŸ³é¢‘é—®é¢˜">éŸ³é¢‘é—®é¢˜</Option>
                            <Option value="å­—å¹•é—®é¢˜">å­—å¹•é—®é¢˜</Option>
                            <Option value="å†…å®¹ä¸ç¬¦åˆè¦æ±‚">å†…å®¹ä¸ç¬¦åˆè¦æ±‚</Option>
                            <Option value="å…¶ä»–">å…¶ä»–</Option>
                          </Select>
                        </Form.Item>
                        <Form.Item name="content" label="ä¿®æ”¹ç‚¹" rules={[{ required: true, message: 'è¯·è¾“å…¥ä¿®æ”¹ç‚¹' }]}>
                          <TextArea rows={4} placeholder="è¯·è¯¦ç»†è¯´æ˜éœ€è¦ä¿®æ”¹çš„å†…å®¹" />
                        </Form.Item>
                        <Form.Item>
                          <Space style={{ width: '100%', justifyContent: 'flex-end' }}>
                            <Button onClick={handleCloseRevisionModal}>å–æ¶ˆ</Button>
                            <Button type="primary" htmlType="submit">æäº¤ä¿®æ”¹æ„è§</Button>
                          </Space>
                        </Form.Item>
                      </Form>
                    </Modal>
                    
                    <Upload
                      beforeUpload={handleUpload}
                      showUploadList={false}
                    >
                      <Button type="primary" size="large" style={{ marginTop: 16 }}>
                        ğŸ“¤ ä¸Šä¼ æ–°ç‰ˆæœ¬
                      </Button>
                    </Upload>
                  </div>
                </TabPane>

                <TabPane tab="ğŸ’­ æ²Ÿé€š" key="messages">
                  <div style={{ marginTop: 16 }}>
                    <List
                      dataSource={orderData.messages || []}
                      renderItem={(item) => (
                        <List.Item>
                          <List.Item.Meta
                            avatar={<Avatar>{item.sender.charAt(0)}</Avatar>}
                            title={
                              <Space>
                                <span>{item.sender}</span>
                                <span style={{ color: '#8c8c8c', fontSize: 12 }}>
                                  {dayjs(item.time).format('YYYY-MM-DD HH:mm:ss')}
                                </span>
                              </Space>
                            }
                            description={
                              <div>
                                {item.content && (
                                  <div style={{ marginBottom: item.images && item.images.length > 0 ? 8 : 0 }}>
                                    {item.content}
                                  </div>
                                )}
                                {item.images && item.images.length > 0 && (
                                  <div style={{ display: 'flex', flexWrap: 'wrap', gap: 8, marginTop: 8 }}>
                                    {item.images.map((img, index) => (
                                      <div key={index} style={{ position: 'relative' }}>
                                        <img
                                          src={img.url}
                                          alt={img.name}
                                          style={{
                                            maxWidth: '200px',
                                            maxHeight: '200px',
                                            borderRadius: '4px',
                                            cursor: 'pointer',
                                            border: '1px solid #e8e8e8',
                                          }}
                                          onClick={() => {
                                            Modal.info({
                                              title: img.name,
                                              content: (
                                                <img
                                                  src={img.url}
                                                  alt={img.name}
                                                  style={{ width: '100%', maxHeight: '600px', objectFit: 'contain' }}
                                                />
                                              ),
                                              width: 800,
                                            });
                                          }}
                                        />
                                      </div>
                                    ))}
                                  </div>
                                )}
                              </div>
                            }
                          />
                        </List.Item>
                      )}
                    />
                    <div style={{ marginTop: 16, padding: '16px', background: '#fafafa', borderRadius: '8px' }}>
                      <TextArea
                        rows={4}
                        placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹"
                        value={messageContent}
                        onChange={(e) => setMessageContent(e.target.value)}
                        style={{ marginBottom: 12 }}
                      />
                      <div style={{ marginBottom: 12 }}>
                        <Upload
                          accept="image/*"
                          beforeUpload={handleImageUpload}
                          onRemove={handleRemoveImage}
                          fileList={messageImages}
                          listType="picture-card"
                          maxCount={9}
                        >
                          {messageImages.length < 9 && (
                            <div>
                              <div style={{ fontSize: 24 }}>+</div>
                              <div style={{ marginTop: 8 }}>ä¸Šä¼ å›¾ç‰‡</div>
                            </div>
                          )}
                        </Upload>
                      </div>
                      <Button type="primary" onClick={handleSendMessage}>å‘é€æ¶ˆæ¯</Button>
                    </div>
                  </div>
                </TabPane>

                <TabPane tab="ğŸ“‹ è®¢å•" key="review">
                  <div style={{ marginTop: 16 }}>
                    <Card title="é¡¹ç›®è®¢å•" style={{ marginBottom: 16 }}>
                      {reviewTableDataSource.length === 0 ? (
                        <div style={{ textAlign: 'center', padding: '24px', color: '#8c8c8c' }}>æš‚æ— è®¢å•æ•°æ®</div>
                      ) : (
                        <Table
                          dataSource={reviewTableDataSource}
                          rowKey={(r) => r.orderId || r.id || String(reviewTableDataSource.indexOf(r))}
                          pagination={{ pageSize: 10, showTotal: (total) => `å…± ${total} æ¡è®¢å•` }}
                          size="small"
                          scroll={{ x: 1000 }}
                          columns={[
                            { title: 'è®¢å•å·', dataIndex: 'orderId', key: 'orderId', width: 160, render: (v) => v || '-' },
                            { title: 'æ¥å•ç”¨æˆ·', dataIndex: 'taker', key: 'taker', width: 120, render: (v) => v || '-' },
                            { title: 'æ¥å•è§’è‰²', dataIndex: 'takerRole', key: 'takerRole', width: 100, render: (v) => v || '-' },
                            { title: 'é›†æ•°', dataIndex: 'episodeCount', key: 'episodeCount', width: 80, render: (v) => v != null ? `${v} é›†` : '-' },
                            { title: 'äº¤ä»˜æƒ…å†µ', key: 'deliveries', width: 100, render: () => (orderData.deliveries && orderData.deliveries.length > 0) ? `å…± ${orderData.deliveries.length} ä¸ªç‰ˆæœ¬` : '-' },
                            { title: 'è®¢å•é‡‘é¢', key: 'baseAmount', width: 140, render: (_, r) => (r.unitPrice != null && r.episodeCount != null) ? `Â¥${(r.unitPrice * r.episodeCount).toFixed(2)}` : '-' },
                            { title: 'å·®é¢', key: 'amountAdjust', width: 180, render: (_, record) => (
                              <Space size="small">
                                <InputNumber
                                  min={-999999}
                                  max={999999}
                                  step={1}
                                  precision={0}
                                  value={record.amountAdjust ?? 0}
                                  onChange={(v) => {
                                    const val = Math.round(Number(v) || 0);
                                    if (orderData.orders && orderData.orders.length > 0) {
                                      const next = orderData.orders.map(o => (o.orderId === record.orderId || o.id === record.orderId) ? { ...o, amountAdjust: val } : o);
                                      setOrderData({ ...orderData, orders: next });
                                    } else {
                                      setOrderData({ ...orderData, amountAdjust: val });
                                    }
                                  }}
                                  style={{ width: 120 }}
                                />
                                <Button type="primary" size="small" onClick={() => { setAmountAdjustEditingRecord(record); setAmountAdjustEditingValue(record.amountAdjust ?? 0); setAmountAdjustReason(''); setAmountAdjustModalVisible(true); }}>ä¿å­˜</Button>
                              </Space>
                            )},
                            { title: 'åˆè®¡é‡‘é¢', key: 'total', width: 120, render: (_, r) => {
                              const base = (r.unitPrice != null && r.episodeCount != null) ? r.unitPrice * r.episodeCount : 0;
                              const adj = Number(r.amountAdjust) || 0;
                              return base || adj ? `Â¥${(base + adj).toFixed(2)}` : '-';
                            }},
                            { title: 'å·®é¢åŸå› ', dataIndex: 'amountAdjustReason', key: 'amountAdjustReason', width: 160, ellipsis: true, render: (v) => v || '-' },
                          ]}
                        />
                      )}
                      <Text type="secondary" style={{ display: 'block', marginTop: 12 }}>å·®é¢ï¼šæ­£æ•°ä¸ºåŠ æ¬¾ï¼Œè´Ÿæ•°ä¸ºæ‰£æ¬¾ã€‚ä¿®æ”¹åç‚¹å‡»è¯¥è¡Œã€Œä¿å­˜ã€é¡»å¡«å†™åŸå› ï¼ˆç•™ç—•ï¼‰åç”Ÿæ•ˆã€‚</Text>
                    </Card>

                    {orderId && (orderData.status === 'Approved' ? (
                      <Card>
                        <Alert message="å½“å‰è®¢å•å·²é€šè¿‡å®¡æ ¸ï¼Œå¯ç”³è¯·éªŒæ”¶" type="success" showIcon style={{ marginBottom: 16 }} />
                        <Button type="primary" size="large" onClick={handleAccept}>ç”³è¯·éªŒæ”¶</Button>
                      </Card>
                    ) : orderData.status === 'Accepted' ? (
                      <Card>
                        <Alert message="å½“å‰è®¢å•å·²éªŒæ”¶ï¼Œæ”¶ç›Šå·²å…¥è´¦" type="success" showIcon />
                      </Card>
                    ) : (
                      <div style={{ textAlign: 'center', padding: '24px', color: '#8c8c8c' }}>
                        {orderData.status === 'Submitted' ? 'å½“å‰è®¢å•å·²æäº¤ï¼Œç­‰å¾…å®¡æ ¸' : orderData.status === 'NeedRevision' ? 'å½“å‰è®¢å•å·²é€€å›ä¿®æ”¹' : 'å½“å‰è®¢å•å°šæœªé€šè¿‡å®¡æ ¸'}
                      </div>
                    ))}
                  </div>
                </TabPane>
              </Tabs>
            </Card>
            </div>
          </div>

          {/* ä¸Šä¼ æ–‡ä»¶å¯¹è¯æ¡† */}
          {/* å·®é¢ä¿å­˜å¼¹çª—ï¼šå¿…å¡«åŸå›  */}
          <Modal
            title="ä¿å­˜å·®é¢"
            open={amountAdjustModalVisible}
            onOk={() => amountAdjustEditingRecord && handleSaveAmountAdjust(amountAdjustEditingRecord, amountAdjustEditingValue, amountAdjustReason)}
            onCancel={() => {
              setAmountAdjustModalVisible(false);
              setAmountAdjustReason('');
              setAmountAdjustEditingRecord(null);
            }}
            okText="ç¡®è®¤ä¿å­˜"
            cancelText="å–æ¶ˆ"
          >
            <div style={{ marginBottom: 16 }}>
              <Text strong>è®¢å•å·ï¼š</Text>
              <span>{amountAdjustEditingRecord?.orderId || '-'}</span>
            </div>
            <div style={{ marginBottom: 16 }}>
              <Text strong style={{ display: 'block', marginBottom: 8 }}>å·®é¢ï¼ˆå…ƒï¼‰</Text>
              <InputNumber
                min={-999999}
                max={999999}
                step={1}
                precision={0}
                value={amountAdjustEditingValue}
                onChange={(v) => setAmountAdjustEditingValue(v ?? 0)}
                style={{ width: '100%' }}
              />
            </div>
            <div>
              <Text strong style={{ display: 'block', marginBottom: 8 }}>åŸå› ï¼ˆå¿…å¡«ï¼‰</Text>
              <TextArea
                rows={4}
                placeholder="è¯·å¡«å†™å·®é¢åŸå› ï¼Œç”¨äºç•™ç—•ä¸å¯¹è´¦"
                value={amountAdjustReason}
                onChange={(e) => setAmountAdjustReason(e.target.value)}
              />
            </div>
          </Modal>

          <Modal
            title="ä¸Šä¼ äº¤ä»˜æ–‡ä»¶"
            open={uploadModalVisible}
            onOk={handleConfirmUpload}
            onCancel={() => {
              setUploadModalVisible(false);
              setChangeNote('');
              setEpisodeNumber(1);
            }}
          >
            <div style={{ marginBottom: 16 }}>
              <Upload
                beforeUpload={() => false}
                showUploadList={true}
              >
                <Button>é€‰æ‹©æ–‡ä»¶</Button>
              </Upload>
            </div>
            <div style={{ marginBottom: 16 }}>
              <Text strong style={{ display: 'block', marginBottom: 8 }}>ç¬¬å‡ é›†</Text>
              <InputNumber
                min={1}
                max={orderData?.episodeCount || 999}
                value={episodeNumber}
                onChange={(v) => setEpisodeNumber(v ?? 1)}
                placeholder="å¡«å†™æœ¬é™„ä»¶å¯¹åº”çš„é›†æ•°"
                style={{ width: '100%' }}
              />
              {orderData?.episodeCount != null && (
                <Text type="secondary" style={{ fontSize: 12, marginTop: 4 }}>æœ¬è®¢å•å…± {orderData.episodeCount} é›†</Text>
              )}
            </div>
            <div style={{ marginBottom: 16, padding: '12px', background: '#f6ffed', border: '1px solid #b7eb8f', borderRadius: 4 }}>
              <Text strong>æœ¬æ¬¡å°†ä¸ºï¼š</Text>
              <Text>ç¬¬ {episodeNumber || 1} é›† ç¬¬ {(orderData?.deliveries || []).filter((d) => Number(d.episodeNumber) === Number(episodeNumber || 1)).length + 1} ç‰ˆ</Text>
              <Text type="secondary" style={{ marginLeft: 8 }}>ï¼ˆç‰ˆæœ¬å·ï¼šV{episodeNumber || 1}-{(orderData?.deliveries || []).filter((d) => Number(d.episodeNumber) === Number(episodeNumber || 1)).length + 1}ï¼‰</Text>
            </div>
            <div>
              <Text strong>å˜æ›´è¯´æ˜ï¼š</Text>
              <TextArea
                rows={4}
                placeholder="è¯·è¯´æ˜æœ¬æ¬¡æäº¤çš„å˜æ›´å†…å®¹"
                value={changeNote}
                onChange={(e) => setChangeNote(e.target.value)}
                style={{ marginTop: 8 }}
              />
            </div>
          </Modal>

          <Modal
            title="æ·»åŠ æˆå‘˜"
            open={addMemberModalVisible}
            onOk={handleAddMember}
            onCancel={() => {
              setAddMemberModalVisible(false);
              setNewMemberName('');
              setNewMemberRole('å­¦å‘˜');
              setNewMemberAvatar('ğŸ‘¤');
            }}
            okText="æ·»åŠ "
            cancelText="å–æ¶ˆ"
          >
            <div style={{ marginBottom: 16 }}>
              <Text strong style={{ display: 'block', marginBottom: 8 }}>å§“å</Text>
              <Input
                placeholder="è¯·è¾“å…¥æˆå‘˜å§“å"
                value={newMemberName}
                onChange={(e) => setNewMemberName(e.target.value)}
              />
            </div>
            <div style={{ marginBottom: 16 }}>
              <Text strong style={{ display: 'block', marginBottom: 8 }}>è§’è‰²</Text>
              <Select
                placeholder="è¯·é€‰æ‹©è§’è‰²"
                value={newMemberRole}
                onChange={setNewMemberRole}
                style={{ width: '100%' }}
              >
                <Option value="å­¦å‘˜">å­¦å‘˜</Option>
                <Option value="è¿è¥">è¿è¥</Option>
                <Option value="å®¡æ ¸">å®¡æ ¸</Option>
                <Option value="å‰ªè¾‘å¸ˆ">å‰ªè¾‘å¸ˆ</Option>
                <Option value="å…¶ä»–">å…¶ä»–</Option>
              </Select>
            </div>
            <div style={{ marginBottom: 16 }}>
              <Text strong style={{ display: 'block', marginBottom: 8 }}>å¤´åƒ</Text>
              <Select
                placeholder="è¯·é€‰æ‹©å¤´åƒ"
                value={newMemberAvatar}
                onChange={setNewMemberAvatar}
                style={{ width: '100%' }}
              >
                <Option value="ğŸ‘¤">ğŸ‘¤ é»˜è®¤</Option>
                <Option value="ğŸ‘¨â€ğŸ’¼">ğŸ‘¨â€ğŸ’¼ è¿è¥</Option>
                <Option value="ğŸ‘©â€ğŸ’¼">ğŸ‘©â€ğŸ’¼ å®¡æ ¸</Option>
                <Option value="âœ‚ï¸">âœ‚ï¸ å‰ªè¾‘</Option>
                <Option value="ğŸ“‹">ğŸ“‹ å…¶ä»–</Option>
              </Select>
            </div>
          </Modal>
        </div>
      );
    };

    function renderApp() {
      if (typeof React === 'undefined' || typeof ReactDOM === 'undefined') {
        setTimeout(renderApp, 100);
        return;
      }
      
      try {
        ReactDOM.render(<ProjectSpace />, document.getElementById('root'));
      } catch (error) {
        console.error('æ¸²æŸ“é”™è¯¯:', error);
        document.getElementById('root').innerHTML = '<div style="padding: 20px; color: red;">é¡µé¢åŠ è½½å¤±è´¥: ' + error.message + '</div>';
      }
    }

    if (document.readyState === 'loading') {
      window.addEventListener('load', renderApp);
    } else {
      renderApp();
    }
  </script>
</body>
</html>
