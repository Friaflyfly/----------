<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è´¢åŠ¡å¯¹è´¦ - å¤©åˆçŸ­å‰§å‰ªè¾‘æ¥å•å¹³å°</title>
  
  <!-- Ant Design CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@5.12.8/dist/reset.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@5.12.8/dist/antd.min.css">
  
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    .appLayout {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 200px;
      background: #fff;
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.06);
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      overflow-y: auto;
      z-index: 100;
    }

    .sidebarHeader {
      padding: 20px 16px;
      border-bottom: 1px solid #f0f0f0;
    }

    .logo {
      font-size: 18px;
      font-weight: 600;
      color: #1890ff;
      text-decoration: none;
      display: block;
    }

    .menu {
      padding: 16px 0;
    }

    .menuItem {
      display: block;
      padding: 12px 24px;
      color: #262626;
      text-decoration: none;
      font-size: 14px;
      transition: all 0.3s;
      border-left: 3px solid transparent;
    }

    .menuItem:hover {
      background-color: #f0f0f0;
      color: #1890ff;
    }

    .menuItem.active {
      background-color: #e6f7ff;
      color: #1890ff;
      border-left-color: #1890ff;
      font-weight: 500;
    }

    .menuItemIcon {
      margin-right: 8px;
      font-size: 16px;
    }

    .menuGroup {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #f0f0f0;
    }

    .menuGroupTitle {
      padding: 8px 24px;
      font-size: 12px;
      color: #8c8c8c;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .mainContent {
      flex: 1;
      margin-left: 200px;
      min-height: 100vh;
      background: #f5f5f5;
    }

    .financePage {
      padding: 24px;
    }

    .pageHeader {
      background: #fff;
      padding: 16px 24px;
      border-radius: 8px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    .statsCard {
      background: #fff;
      padding: 24px;
      border-radius: 8px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    .statsGrid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 24px;
    }

    .statItem {
      text-align: center;
    }

    .statLabel {
      font-size: 14px;
      color: #8c8c8c;
      margin-bottom: 8px;
    }

    .statValue {
      font-size: 24px;
      font-weight: 600;
      color: #262626;
    }

    .statValue.primary {
      color: #1890ff;
    }

    .statValue.success {
      color: #52c41a;
    }

    .statValue.warning {
      color: #fa8c16;
    }

    .filterCard {
      background: #fff;
      padding: 16px 24px;
      border-radius: 8px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    .tableCard {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    @media (max-width: 768px) {
      .sidebar {
        display: none;
      }

      .mainContent {
        margin-left: 0;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  
  <!-- Day.js -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
  
  <!-- Ant Design JS -->
  <script src="https://cdn.jsdelivr.net/npm/antd@5.12.8/dist/antd.min.js"></script>
  
  <!-- Babel Standalone for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    const { Card, Table, Button, Tag, Space, Select, DatePicker, Typography, Statistic, Modal, Form, Input, InputNumber, message } = antd;
    const { Title } = Typography;
    const { Option } = Select;
    const { RangePicker } = DatePicker;
    const { TextArea } = Input;

    const FinanceManagement = () => {
      const [ledger, setLedger] = useState([]);
      const [loading, setLoading] = useState(false);
      const [filters, setFilters] = useState({
        settlementStatus: '',
        dateRange: null,
      });
      const [adjustModalVisible, setAdjustModalVisible] = useState(false);
      const [settleModalVisible, setSettleModalVisible] = useState(false);
      const [adjustForm] = Form.useForm();
      const [currentRecord, setCurrentRecord] = useState(null);

      useEffect(() => {
        loadLedger();
      }, []);

      const loadLedger = () => {
        setLoading(true);
        
        // ä»è®¢å•æ•°æ®ç”Ÿæˆè´¦æœ¬
        const orders = JSON.parse(localStorage.getItem('currentOrders') || '[]');
        const acceptedOrders = orders.filter(o => o.status === 'Accepted');
        
        let ledgerData = acceptedOrders.map(order => ({
          id: `ledger_${order.id}`,
          orderId: order.id,
          projectName: order.projectName || 'æµ‹è¯•é¡¹ç›®',
          taker: order.taker || 'å­¦å‘˜A',
          amount: order.amount || Math.floor(Math.random() * 1000) + 500,
          acceptTime: order.acceptTime || dayjs().subtract(Math.floor(Math.random() * 30), 'day').format('YYYY-MM-DD HH:mm:ss'),
          deduction: 0,
          settlementStatus: ['æœªç»“ç®—', 'å·²ç»“ç®—'][Math.floor(Math.random() * 2)],
          settlementMonth: null,
        }));

        // ä»localStorageè¯»å–å·²æœ‰è´¦æœ¬æ•°æ®
        const savedLedger = JSON.parse(localStorage.getItem('financeLedger') || '[]');
        if (savedLedger.length > 0) {
          ledgerData = savedLedger;
        } else {
          localStorage.setItem('financeLedger', JSON.stringify(ledgerData));
        }

        setLedger(ledgerData);
        setLoading(false);
      };

      const filteredLedger = useMemo(() => {
        return ledger.filter(item => {
          if (filters.settlementStatus && item.settlementStatus !== filters.settlementStatus) return false;
          if (filters.dateRange && filters.dateRange[0] && filters.dateRange[1]) {
            const acceptTime = dayjs(item.acceptTime);
            if (acceptTime.isBefore(filters.dateRange[0]) || acceptTime.isAfter(filters.dateRange[1])) {
              return false;
            }
          }
          return true;
        });
      }, [ledger, filters]);

      const stats = useMemo(() => {
        const totalAmount = filteredLedger.reduce((sum, item) => sum + (item.amount || 0), 0);
        const totalDeduction = filteredLedger.reduce((sum, item) => sum + (item.deduction || 0), 0);
        const settledAmount = filteredLedger
          .filter(item => item.settlementStatus === 'å·²ç»“ç®—')
          .reduce((sum, item) => sum + (item.amount || 0) - (item.deduction || 0), 0);
        const unsettledAmount = filteredLedger
          .filter(item => item.settlementStatus === 'æœªç»“ç®—')
          .reduce((sum, item) => sum + (item.amount || 0) - (item.deduction || 0), 0);

        return {
          totalAmount,
          totalDeduction,
          settledAmount,
          unsettledAmount,
          totalCount: filteredLedger.length,
          settledCount: filteredLedger.filter(item => item.settlementStatus === 'å·²ç»“ç®—').length,
        };
      }, [filteredLedger]);

      const handleAdjust = (record) => {
        setCurrentRecord(record);
        adjustForm.setFieldsValue({ deduction: record.deduction || 0, reason: '' });
        setAdjustModalVisible(true);
      };

      const handleAdjustSubmit = () => {
        adjustForm.validateFields().then(values => {
          const updatedLedger = ledger.map(item =>
            item.id === currentRecord.id
              ? { ...item, deduction: values.deduction, adjustReason: values.reason, adjustTime: dayjs().format('YYYY-MM-DD HH:mm:ss') }
              : item
          );
          setLedger(updatedLedger);
          localStorage.setItem('financeLedger', JSON.stringify(updatedLedger));
          setAdjustModalVisible(false);
          adjustForm.resetFields();
          message.success('æ‰£æ¬¾è°ƒæ•´å·²ä¿å­˜');
        });
      };

      const handleSettle = (record) => {
        setCurrentRecord(record);
        setSettleModalVisible(true);
      };

      const handleSettleSubmit = () => {
        const updatedLedger = ledger.map(item =>
          item.id === currentRecord.id
            ? { ...item, settlementStatus: 'å·²ç»“ç®—', settlementMonth: dayjs().format('YYYY-MM') }
            : item
        );
        setLedger(updatedLedger);
        localStorage.setItem('financeLedger', JSON.stringify(updatedLedger));
        setSettleModalVisible(false);
        message.success('å·²æ ‡è®°ä¸ºå·²ç»“ç®—');
      };

      const handleExport = () => {
        message.success('å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­');
      };

      const columns = [
        { title: 'è®¢å•å·', dataIndex: 'orderId', key: 'orderId', width: 150 },
        { title: 'é¡¹ç›®å', dataIndex: 'projectName', key: 'projectName', width: 200, ellipsis: true },
        { title: 'æ¥å•äºº', dataIndex: 'taker', key: 'taker', width: 120 },
        { title: 'é‡‘é¢', dataIndex: 'amount', key: 'amount', width: 120, render: (amount) => `Â¥${amount}` },
        { title: 'éªŒæ”¶æ—¶é—´ï¼ˆå…¥è´¦ï¼‰', dataIndex: 'acceptTime', key: 'acceptTime', width: 180 },
        { title: 'æ‰£æ¬¾è°ƒæ•´', dataIndex: 'deduction', key: 'deduction', width: 120, render: (deduction) => 
          deduction > 0 ? <span style={{ color: '#ff4d4f' }}>-Â¥{deduction}</span> : '-' },
        { title: 'ç»“ç®—çŠ¶æ€', dataIndex: 'settlementStatus', key: 'settlementStatus', width: 100, render: (status) => 
          <Tag color={status === 'å·²ç»“ç®—' ? 'green' : 'orange'}>{status}</Tag> },
        { title: 'ç»“ç®—æœˆä»½', dataIndex: 'settlementMonth', key: 'settlementMonth', width: 120, render: (month) => month || '-' },
        { title: 'æ“ä½œ', key: 'action', width: 200, render: (_, record) => (
          <Space>
            <Button size="small" onClick={() => handleAdjust(record)}>ä¿®æ”¹å·®é¢</Button>
            {record.settlementStatus === 'æœªç»“ç®—' && (
              <Button size="small" type="primary" onClick={() => handleSettle(record)}>æ ‡è®°å·²ç»“ç®—</Button>
            )}
          </Space>
        )},
      ];

      return (
        <div className="appLayout">
          {/* å·¦ä¾§å¯¼èˆªæ  */}
          <div className="sidebar">
            <div className="sidebarHeader">
              <a href="Home.html" className="logo">ğŸ¬ å¤©åˆçŸ­å‰§å¹³å°</a>
            </div>
            <nav className="menu">
              <a href="Home.html" className="menuItem">
                <span className="menuItemIcon">ğŸ </span>
                é¦–é¡µ
              </a>
              <a href="ProjectHall.html" className="menuItem">
                <span className="menuItemIcon">ğŸ“‹</span>
                æ¥å•å¤§å…
              </a>
              <a href="Leaderboard.html" className="menuItem">
                <span className="menuItemIcon">ğŸ†</span>
                å¤©æ¢¯æ¦œå•
              </a>
              <a href="Account.html" className="menuItem">
                <span className="menuItemIcon">ğŸ’°</span>
                è´¦æˆ·ä¸æ”¶ç›Š
              </a>
              <a href="MyProjects.html" className="menuItem">
                <span className="menuItemIcon">ğŸš€</span>
                æˆ‘çš„é¡¹ç›®
              </a>
              
              <div className="menuGroup">
                <div className="menuGroupTitle">åå°ç®¡ç†</div>
                <a href="ReviewQueue.html" className="menuItem">
                  <span className="menuItemIcon">âœ…</span>
                  è®¢å•å®¡æ ¸
                </a>
                <a href="ProjectManagement.html" className="menuItem">
                  <span className="menuItemIcon">ğŸ“‹</span>
                  é¡¹ç›®ç®¡ç†
                </a>
                <a href="StudentManagement.html" className="menuItem">
                  <span className="menuItemIcon">ğŸ‘¥</span>
                  å­¦å‘˜ç®¡ç†
                </a>
                <a href="FinanceManagement.html" className="menuItem active">
                  <span className="menuItemIcon">ğŸ’°</span>
                  è´¢åŠ¡å¯¹è´¦
                </a>
                <a href="DashboardManagement.html" className="menuItem">
                  <span className="menuItemIcon">ğŸ“Š</span>
                  æ¦œå•ä¸æ•°æ®
                </a>
              </div>
            </nav>
          </div>

          {/* ä¸»å†…å®¹åŒº */}
          <div className="mainContent">
            <div className="financePage">
              <div className="pageHeader">
                <Title level={2} style={{ margin: 0 }}>è´¢åŠ¡å¯¹è´¦</Title>
                <Button onClick={handleExport}>å¯¼å‡ºå¯¹è´¦æŠ¥è¡¨</Button>
              </div>

              {/* ç»Ÿè®¡å¡ç‰‡ */}
              <div className="statsCard">
                <div className="statsGrid">
                  <div className="statItem">
                    <div className="statLabel">éªŒæ”¶è®¢å•æ•°</div>
                    <div className="statValue primary">{stats.totalCount}</div>
                  </div>
                  <div className="statItem">
                    <div className="statLabel">åº”ä»˜é‡‘é¢</div>
                    <div className="statValue success">Â¥{stats.totalAmount.toLocaleString()}</div>
                  </div>
                  <div className="statItem">
                    <div className="statLabel">æ‰£æ¬¾è°ƒæ•´</div>
                    <div className="statValue warning">Â¥{stats.totalDeduction.toLocaleString()}</div>
                  </div>
                  <div className="statItem">
                    <div className="statLabel">å·²ç»“ç®—é‡‘é¢</div>
                    <div className="statValue success">Â¥{stats.settledAmount.toLocaleString()}</div>
                  </div>
                  <div className="statItem">
                    <div className="statLabel">æœªç»“ç®—é‡‘é¢</div>
                    <div className="statValue warning">Â¥{stats.unsettledAmount.toLocaleString()}</div>
                  </div>
                  <div className="statItem">
                    <div className="statLabel">å·²ç»“ç®—è®¢å•æ•°</div>
                    <div className="statValue primary">{stats.settledCount}</div>
                  </div>
                </div>
              </div>

              {/* ç­›é€‰åŒº */}
              <div className="filterCard">
                <Space size="middle" wrap>
                  <span>ç»“ç®—çŠ¶æ€ï¼š</span>
                  <Select
                    style={{ width: 150 }}
                    placeholder="å…¨éƒ¨"
                    allowClear
                    value={filters.settlementStatus}
                    onChange={(value) => setFilters({ ...filters, settlementStatus: value || '' })}
                  >
                    <Option value="æœªç»“ç®—">æœªç»“ç®—</Option>
                    <Option value="å·²ç»“ç®—">å·²ç»“ç®—</Option>
                  </Select>

                  <span>éªŒæ”¶æ—¶é—´ï¼š</span>
                  <RangePicker
                    value={filters.dateRange}
                    onChange={(dates) => setFilters({ ...filters, dateRange: dates })}
                  />
                </Space>
              </div>

              {/* è¡¨æ ¼ */}
              <div className="tableCard">
                <Table
                  columns={columns}
                  dataSource={filteredLedger}
                  loading={loading}
                  rowKey="id"
                  scroll={{ x: 1200 }}
                  pagination={{ pageSize: 20, showTotal: (total) => `å…± ${total} æ¡` }}
                />
              </div>
            </div>
          </div>

          {/* ä¿®æ”¹å·®é¢å¼¹çª— */}
          <Modal
            title="ä¿®æ”¹å·®é¢"
            open={adjustModalVisible}
            onOk={handleAdjustSubmit}
            onCancel={() => { setAdjustModalVisible(false); adjustForm.resetFields(); }}
            okText="ç¡®è®¤"
            cancelText="å–æ¶ˆ"
            width={600}
          >
            <Form form={adjustForm} layout="vertical">
              <Form.Item
                name="deduction"
                label="æ‰£æ¬¾é‡‘é¢"
                rules={[{ required: true, message: 'è¯·è¾“å…¥æ‰£æ¬¾é‡‘é¢' }]}
              >
                <InputNumber min={0} style={{ width: '100%' }} placeholder="è¯·è¾“å…¥æ‰£æ¬¾é‡‘é¢" />
              </Form.Item>
              <Form.Item
                name="reason"
                label="æ‰£æ¬¾åŸå› "
                rules={[{ required: true, message: 'è¯·å¡«å†™æ‰£æ¬¾åŸå› ' }]}
              >
                <TextArea rows={4} placeholder="è¯·å¡«å†™æ‰£æ¬¾åŸå› " />
              </Form.Item>
            </Form>
          </Modal>

          {/* ç»“ç®—ç¡®è®¤å¼¹çª— */}
          <Modal
            title="ç¡®è®¤ç»“ç®—"
            open={settleModalVisible}
            onOk={handleSettleSubmit}
            onCancel={() => setSettleModalVisible(false)}
            okText="ç¡®è®¤"
            cancelText="å–æ¶ˆ"
          >
            <p>ç¡®å®šå°†è¯¥è®¢å•æ ‡è®°ä¸ºå·²ç»“ç®—ï¼Ÿ</p>
            <p style={{ color: '#8c8c8c', fontSize: 12 }}>ç»“ç®—æœˆä»½ï¼š{dayjs().format('YYYY-MM')}</p>
          </Modal>
        </div>
      );
    };

    window.addEventListener('load', function() {
      try {
        ReactDOM.render(<FinanceManagement />, document.getElementById('root'));
      } catch (error) {
        console.error('æ¸²æŸ“é”™è¯¯:', error);
        document.getElementById('root').innerHTML = '<div style="padding: 20px; color: red;">é¡µé¢åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯ä¿¡æ¯ã€‚</div>';
      }
    });
  </script>
</body>
</html>
