<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è®¢å•å®¡æ ¸ - å¤©åˆçŸ­å‰§å‰ªè¾‘æ¥å•å¹³å°</title>
  
  <!-- Ant Design CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@5.12.8/dist/reset.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@5.12.8/dist/antd.min.css">
  
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    .appLayout {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 200px;
      background: #fff;
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.06);
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      overflow-y: auto;
      z-index: 100;
    }

    .sidebarHeader {
      padding: 20px 16px;
      border-bottom: 1px solid #f0f0f0;
    }

    .logo {
      font-size: 18px;
      font-weight: 600;
      color: #1890ff;
      text-decoration: none;
      display: block;
    }

    .menu {
      padding: 16px 0;
    }

    .menuItem {
      display: block;
      padding: 12px 24px;
      color: #262626;
      text-decoration: none;
      font-size: 14px;
      transition: all 0.3s;
      border-left: 3px solid transparent;
    }

    .menuItem:hover {
      background-color: #f0f0f0;
      color: #1890ff;
    }

    .menuItem.active {
      background-color: #e6f7ff;
      color: #1890ff;
      border-left-color: #1890ff;
      font-weight: 500;
    }

    .menuItemIcon {
      margin-right: 8px;
      font-size: 16px;
    }

    .menuGroup {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #f0f0f0;
    }

    .menuGroupTitle {
      padding: 8px 24px;
      font-size: 12px;
      color: #8c8c8c;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .mainContent {
      flex: 1;
      margin-left: 200px;
      min-height: 100vh;
      background: #f5f5f5;
    }

    .reviewPage {
      padding: 24px;
    }

    .pageHeader {
      background: #fff;
      padding: 16px 24px;
      border-radius: 8px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    .pageTitle {
      font-size: 20px;
      font-weight: 600;
      color: #262626;
      margin: 0;
    }

    .filterCard {
      background: #fff;
      padding: 16px 24px;
      border-radius: 8px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    .tableCard {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    @media (max-width: 768px) {
      .sidebar {
        display: none;
      }

      .mainContent {
        margin-left: 0;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  
  <!-- Day.js -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
  
  <!-- Ant Design JS -->
  <script src="https://cdn.jsdelivr.net/npm/antd@5.12.8/dist/antd.min.js"></script>
  
  <!-- Babel Standalone for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    const { Card, Table, Button, Tag, Space, Select, Input, Typography, Badge, message } = antd;
    const { Title } = Typography;
    const { Option } = Select;
    const { Search } = Input;

    const ReviewQueue = () => {
      const [reviewList, setReviewList] = useState([]);
      const [loading, setLoading] = useState(false);
      const [filters, setFilters] = useState({
        riskLevel: '',
        search: '',
      });

      useEffect(() => {
        loadReviewData();
      }, []);

      const loadReviewData = () => {
        setLoading(true);
        
        // ç¡®ä¿æœ‰æµ‹è¯•è®¢å•æ•°æ®
        ensureTestOrders();
        
        // ä» localStorage è¯»å–å®¡æ ¸æ•°æ®
        let reviews = JSON.parse(localStorage.getItem('reviewQueue') || '[]');
        
        // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œç”Ÿæˆæµ‹è¯•æ•°æ®
        if (reviews.length === 0) {
          reviews = generateMockReviewData();
          localStorage.setItem('reviewQueue', JSON.stringify(reviews));
        }

        setReviewList(reviews);
        setLoading(false);
      };

      // ç¡®ä¿æœ‰æµ‹è¯•è®¢å•æ•°æ®
      const ensureTestOrders = () => {
        let orders = JSON.parse(localStorage.getItem('currentOrders') || '[]');
        const hasSubmitted = orders.some(o => o.status === 'Submitted');
        
        if (!hasSubmitted || orders.length === 0) {
          // ç”Ÿæˆæµ‹è¯•è®¢å•ï¼ŒåŒ…å« Submitted çŠ¶æ€çš„è®¢å•ç”¨äºå®¡æ ¸
          const testOrders = [
            {
              id: 'ORD000001',
              orderId: 'ORD000001',
              projectId: 'proj_1',
              projectName: 'éœ¸é“æ€»è£çˆ±ä¸Šæˆ‘',
              taker: 'å­¦å‘˜A',
              status: 'Submitted',
              takeTime: dayjs().subtract(5, 'day').format('YYYY-MM-DD HH:mm:ss'),
              dueTime: dayjs().add(2, 'day').format('YYYY-MM-DD HH:mm:ss'),
              submitTime: dayjs().subtract(2, 'hour').format('YYYY-MM-DD HH:mm:ss'),
              version: 'V1',
              amount: 10000,
            },
            {
              id: 'ORD000002',
              orderId: 'ORD000002',
              projectId: 'proj_2',
              projectName: 'AIæ¼«å‰§ï¼šç©¿è¶Šæ—¶ç©ºçš„å†’é™©',
              taker: 'å­¦å‘˜B',
              status: 'Submitted',
              takeTime: dayjs().subtract(4, 'day').format('YYYY-MM-DD HH:mm:ss'),
              dueTime: dayjs().add(1, 'day').format('YYYY-MM-DD HH:mm:ss'),
              submitTime: dayjs().subtract(4, 'hour').format('YYYY-MM-DD HH:mm:ss'),
              version: 'V1',
              amount: 8000,
            },
            {
              id: 'ORD000003',
              orderId: 'ORD000003',
              projectId: 'proj_3',
              projectName: 'çŸ­å‰§ï¼šå¤è£…ä»™ä¾ ä¼ å¥‡',
              taker: 'å­¦å‘˜C',
              status: 'Submitted',
              takeTime: dayjs().subtract(3, 'day').format('YYYY-MM-DD HH:mm:ss'),
              dueTime: dayjs().add(3, 'day').format('YYYY-MM-DD HH:mm:ss'),
              submitTime: dayjs().subtract(6, 'hour').format('YYYY-MM-DD HH:mm:ss'),
              version: 'V2',
              amount: 12000,
            },
            {
              id: 'ORD000004',
              orderId: 'ORD000004',
              projectId: 'proj_4',
              projectName: 'ç»¼è‰ºå‰ªè¾‘ï¼šçœŸäººç§€ç²¾å½©ç‰‡æ®µ',
              taker: 'å­¦å‘˜D',
              status: 'Submitted',
              takeTime: dayjs().subtract(2, 'day').format('YYYY-MM-DD HH:mm:ss'),
              dueTime: dayjs().add(4, 'day').format('YYYY-MM-DD HH:mm:ss'),
              submitTime: dayjs().subtract(1, 'hour').format('YYYY-MM-DD HH:mm:ss'),
              version: 'V1',
              amount: 6000,
            },
          ];

          // åˆå¹¶ç°æœ‰è®¢å•å’Œæµ‹è¯•è®¢å•ï¼ˆé¿å…é‡å¤ï¼‰
          const existingIds = new Set(orders.map(o => o.orderId || o.id));
          const newOrders = testOrders.filter(o => !existingIds.has(o.orderId));
          orders = [...orders, ...newOrders];
          localStorage.setItem('currentOrders', JSON.stringify(orders));

          // ä¸ºæ¯ä¸ªæµ‹è¯•è®¢å•åˆ›å»ºååŒç©ºé—´æ•°æ®ï¼ˆåŒ…å«äº¤ä»˜ç‰ˆæœ¬ï¼‰
          newOrders.forEach(order => {
            const spaceKey = `orderSpace_${order.orderId}`;
            const existingSpace = localStorage.getItem(spaceKey);
            if (!existingSpace) {
              const spaceData = {
                orderId: order.orderId,
                projectId: order.projectId,
                projectName: order.projectName,
                status: 'Submitted',
                deliveries: [
                  {
                    id: `delivery_${Date.now()}_${order.orderId}`,
                    version: order.version,
                    fileName: `${order.projectName}_${order.version}.zip`,
                    uploadTime: order.submitTime,
                    uploader: order.taker,
                    changeNote: 'é¦–æ¬¡æäº¤äº¤ä»˜æ–‡ä»¶',
                    status: 'Submitted',
                    fileSize: Math.floor(Math.random() * 500000000) + 100000000,
                  },
                ],
                revisions: [],
                messages: [],
              };
              localStorage.setItem(spaceKey, JSON.stringify(spaceData));
            }
          });
        }
      };

      const generateMockReviewData = () => {
        const mockOrders = JSON.parse(localStorage.getItem('currentOrders') || '[]');
        const submittedOrders = mockOrders.filter(order => order.status === 'Submitted');
        
        return submittedOrders.map((order, index) => {
          const submitTime = dayjs().subtract(index * 2, 'hour');
          const dueTime = dayjs(order.dueTime || submitTime.add(3, 'day'));
          const waitHours = dayjs().diff(submitTime, 'hour');
          
          const riskLevels = ['ä½é£é™©', 'ä¸­é£é™©', 'é«˜é£é™©'];
          const riskLevel = riskLevels[Math.floor(Math.random() * riskLevels.length)];
          const tags = ['ç”»é¢è´¨é‡', 'éŸ³é¢‘åŒæ­¥', 'å­—å¹•è§„èŒƒ', 'æ—¶é•¿ç¬¦åˆ', 'å†…å®¹åˆè§„'];
          const hitTags = tags.slice(0, Math.floor(Math.random() * 3) + 1);

          // ç¡®ä¿ orderId å­—æ®µæ­£ç¡®ï¼ˆæ”¯æŒ orderId å’Œ id ä¸¤ç§ï¼‰
          const orderId = order.orderId || order.id || `ORD${String(index + 1).padStart(6, '0')}`;
          
          return {
            id: `review_${orderId}`,
            orderId: orderId,
            projectName: order.projectName || 'æµ‹è¯•é¡¹ç›®',
            taker: order.taker || 'å­¦å‘˜A',
            version: `V${order.version || 1}`,
            submitTime: submitTime.format('YYYY-MM-DD HH:mm:ss'),
            waitHours: waitHours,
            dueTime: dueTime.format('YYYY-MM-DD HH:mm:ss'),
            riskLevel: riskLevel,
            hitTags: hitTags,
            order: order,
          };
        });
      };

      // è¿‡æ»¤å’Œæ’åºæ•°æ®
      const filteredAndSortedData = useMemo(() => {
        let filtered = reviewList.filter(item => {
          if (filters.riskLevel && item.riskLevel !== filters.riskLevel) return false;
          if (filters.search) {
            const searchLower = filters.search.toLowerCase();
            if (!item.orderId.toLowerCase().includes(searchLower) &&
                !item.projectName.toLowerCase().includes(searchLower) &&
                !item.taker.toLowerCase().includes(searchLower)) {
              return false;
            }
          }
          return true;
        });

        // æ’åºï¼šä¸´æœŸä¼˜å…ˆ + ç­‰å¾…æ—¶é•¿
        filtered.sort((a, b) => {
          const dueTimeA = dayjs(a.dueTime);
          const dueTimeB = dayjs(b.dueTime);
          const now = dayjs();
          
          // ä¸´æœŸä¼˜å…ˆï¼šè·ç¦»æˆªæ­¢æ—¶é—´è¶Šè¿‘è¶Šé å‰
          const diffA = dueTimeA.diff(now, 'hour');
          const diffB = dueTimeB.diff(now, 'hour');
          
          if (diffA < 0 && diffB >= 0) return -1; // Aå·²è¶…æœŸï¼ŒBæœªè¶…æœŸ
          if (diffA >= 0 && diffB < 0) return 1; // Bå·²è¶…æœŸï¼ŒAæœªè¶…æœŸ
          if (diffA < 0 && diffB < 0) return diffA - diffB; // éƒ½è¶…æœŸï¼ŒæŒ‰è¶…æœŸæ—¶é—´æ’åº
          
          // éƒ½æœªè¶…æœŸï¼ŒæŒ‰ç­‰å¾…æ—¶é•¿æ’åºï¼ˆç­‰å¾…æ—¶é—´è¶Šé•¿è¶Šé å‰ï¼‰
          return b.waitHours - a.waitHours;
        });

        return filtered;
      }, [reviewList, filters]);

      const handleReview = (record) => {
        window.location.href = `ReviewDetail.html?orderId=${record.orderId}`;
      };

      const getRiskLevelColor = (level) => {
        const colorMap = {
          'ä½é£é™©': 'green',
          'ä¸­é£é™©': 'orange',
          'é«˜é£é™©': 'red',
        };
        return colorMap[level] || 'default';
      };

      const formatWaitTime = (hours) => {
        if (hours < 1) return 'åˆšåˆš';
        if (hours < 24) return `${hours}å°æ—¶`;
        return `${Math.floor(hours / 24)}å¤©${hours % 24}å°æ—¶`;
      };

      const columns = [
        {
          title: 'è®¢å•å·',
          dataIndex: 'orderId',
          key: 'orderId',
          width: 150,
          fixed: 'left',
        },
        {
          title: 'é¡¹ç›®å',
          dataIndex: 'projectName',
          key: 'projectName',
          width: 200,
          ellipsis: true,
        },
        {
          title: 'æ¥å•äºº',
          dataIndex: 'taker',
          key: 'taker',
          width: 120,
        },
        {
          title: 'ç‰ˆæœ¬å·',
          dataIndex: 'version',
          key: 'version',
          width: 100,
        },
        {
          title: 'æäº¤å®¡æ ¸æ—¶é—´',
          dataIndex: 'submitTime',
          key: 'submitTime',
          width: 180,
        },
        {
          title: 'ç­‰å¾…æ—¶é•¿',
          dataIndex: 'waitHours',
          key: 'waitHours',
          width: 120,
          render: (hours) => (
            <Tag color={hours > 24 ? 'red' : hours > 12 ? 'orange' : 'blue'}>
              {formatWaitTime(hours)}
            </Tag>
          ),
        },
        {
          title: 'é¡¹ç›®æˆªæ­¢æ—¶é—´',
          dataIndex: 'dueTime',
          key: 'dueTime',
          width: 180,
          render: (time) => {
            const dueTime = dayjs(time);
            const now = dayjs();
            const isOverdue = dueTime.isBefore(now);
            return (
              <span style={{ color: isOverdue ? '#ff4d4f' : '#262626' }}>
                {time}
                {isOverdue && <Badge status="error" style={{ marginLeft: 8 }} />}
              </span>
            );
          },
        },
        {
          title: 'AIé¢„å®¡é£é™©ç­‰çº§',
          dataIndex: 'riskLevel',
          key: 'riskLevel',
          width: 140,
          render: (level) => (
            <Tag color={getRiskLevelColor(level)}>{level}</Tag>
          ),
        },
        {
          title: 'å‘½ä¸­æ ‡ç­¾',
          dataIndex: 'hitTags',
          key: 'hitTags',
          width: 200,
          render: (tags) => (
            <Space size="small" wrap>
              {tags && tags.map((tag, idx) => (
                <Tag key={idx} color="blue">{tag}</Tag>
              ))}
            </Space>
          ),
        },
        {
          title: 'æ“ä½œ',
          key: 'action',
          width: 120,
          fixed: 'right',
          render: (_, record) => (
            <Button type="primary" size="small" onClick={() => handleReview(record)}>
              è¿›å…¥å®¡æ ¸
            </Button>
          ),
        },
      ];

      return (
        <div className="appLayout">
          {/* å·¦ä¾§å¯¼èˆªæ  */}
          <div className="sidebar">
            <div className="sidebarHeader">
              <a href="Home.html" className="logo">ğŸ¬ å¤©åˆçŸ­å‰§å¹³å°</a>
            </div>
            <nav className="menu">
              <a href="Home.html" className="menuItem">
                <span className="menuItemIcon">ğŸ </span>
                é¦–é¡µ
              </a>
              <a href="ProjectHall.html" className="menuItem">
                <span className="menuItemIcon">ğŸ“‹</span>
                æ¥å•å¤§å…
              </a>
              <a href="Leaderboard.html" className="menuItem">
                <span className="menuItemIcon">ğŸ†</span>
                å¤©æ¢¯æ¦œå•
              </a>
              <a href="Account.html" className="menuItem">
                <span className="menuItemIcon">ğŸ’°</span>
                è´¦æˆ·ä¸æ”¶ç›Š
              </a>
              <a href="MyProjects.html" className="menuItem">
                <span className="menuItemIcon">ğŸš€</span>
                æˆ‘çš„é¡¹ç›®
              </a>
              
              <div className="menuGroup">
                <div className="menuGroupTitle">åå°ç®¡ç†</div>
                <a href="ReviewQueue.html" className="menuItem active">
                  <span className="menuItemIcon">âœ…</span>
                  è®¢å•å®¡æ ¸
                </a>
                <a href="ProjectManagement.html" className="menuItem">
                  <span className="menuItemIcon">ğŸ“‹</span>
                  é¡¹ç›®ç®¡ç†
                </a>
                <a href="StudentManagement.html" className="menuItem">
                  <span className="menuItemIcon">ğŸ‘¥</span>
                  å­¦å‘˜ç®¡ç†
                </a>
                <a href="FinanceManagement.html" className="menuItem">
                  <span className="menuItemIcon">ğŸ’°</span>
                  è´¢åŠ¡å¯¹è´¦
                </a>
                <a href="DashboardManagement.html" className="menuItem">
                  <span className="menuItemIcon">ğŸ“Š</span>
                  æ¦œå•ä¸æ•°æ®
                </a>
              </div>
            </nav>
          </div>

          {/* ä¸»å†…å®¹åŒº */}
          <div className="mainContent">
            <div className="reviewPage">
              <div className="pageHeader">
                <Title level={2} style={{ margin: 0 }}>è®¢å•å®¡æ ¸</Title>
              </div>

              {/* ç­›é€‰åŒº */}
              <div className="filterCard">
                <Space size="middle" wrap>
                  <span>AIé¢„å®¡é£é™©ç­‰çº§ï¼š</span>
                  <Select
                    style={{ width: 150 }}
                    placeholder="å…¨éƒ¨"
                    allowClear
                    value={filters.riskLevel}
                    onChange={(value) => setFilters({ ...filters, riskLevel: value || '' })}
                  >
                    <Option value="ä½é£é™©">ä½é£é™©</Option>
                    <Option value="ä¸­é£é™©">ä¸­é£é™©</Option>
                    <Option value="é«˜é£é™©">é«˜é£é™©</Option>
                  </Select>

                  <Search
                    placeholder="æœç´¢è®¢å•å·/é¡¹ç›®å/æ¥å•äºº"
                    style={{ width: 300 }}
                    allowClear
                    value={filters.search}
                    onChange={(e) => setFilters({ ...filters, search: e.target.value })}
                    onSearch={(value) => setFilters({ ...filters, search: value })}
                  />
                </Space>
              </div>

              {/* è¡¨æ ¼ */}
              <div className="tableCard">
                <Table
                  columns={columns}
                  dataSource={filteredAndSortedData}
                  loading={loading}
                  rowKey="id"
                  scroll={{ x: 1400 }}
                  pagination={{
                    pageSize: 20,
                    showSizeChanger: true,
                    showTotal: (total) => `å…± ${total} æ¡`,
                  }}
                />
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ç­‰å¾…æ‰€æœ‰èµ„æºåŠ è½½å®Œæˆåå†æ¸²æŸ“
    window.addEventListener('load', function() {
      try {
        ReactDOM.render(<ReviewQueue />, document.getElementById('root'));
      } catch (error) {
        console.error('æ¸²æŸ“é”™è¯¯:', error);
        document.getElementById('root').innerHTML = '<div style="padding: 20px; color: red;">é¡µé¢åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯ä¿¡æ¯ã€‚</div>';
      }
    });
  </script>
</body>
</html>
