<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆ‘çš„é¡¹ç›® - å¤©åˆçŸ­å‰§å‰ªè¾‘æ¥å•å¹³å°</title>
  
  <!-- Ant Design CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@5.12.8/dist/reset.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@5.12.8/dist/antd.min.css">
  
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    .appLayout {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 200px;
      background: #fff;
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.06);
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      overflow-y: auto;
      z-index: 100;
    }

    .sidebarHeader {
      padding: 20px 16px;
      border-bottom: 1px solid #f0f0f0;
    }

    .logo {
      font-size: 18px;
      font-weight: 600;
      color: #1890ff;
      text-decoration: none;
      display: block;
    }

    .menu {
      padding: 16px 0;
    }

    .menuItem {
      display: block;
      padding: 12px 24px;
      color: #262626;
      text-decoration: none;
      font-size: 14px;
      transition: all 0.3s;
      border-left: 3px solid transparent;
    }

    .menuItem:hover {
      background-color: #f0f0f0;
      color: #1890ff;
    }

    .menuItem.active {
      background-color: #e6f7ff;
      color: #1890ff;
      border-left-color: #1890ff;
      font-weight: 500;
    }

    .menuItemIcon {
      margin-right: 8px;
      font-size: 16px;
    }

    .menuGroup {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #f0f0f0;
    }

    .menuGroupTitle {
      padding: 8px 24px;
      font-size: 12px;
      color: #8c8c8c;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .mainContent {
      flex: 1;
      margin-left: 200px;
      min-height: 100vh;
      background: #f5f5f5;
    }

    .myProjectsPage {
      padding: 24px;
    }

    .pageHeader {
      background: #fff;
      padding: 16px 24px;
      border-radius: 8px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    .filterCard {
      background: #fff;
      padding: 16px 24px;
      border-radius: 8px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    .tableCard {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    @media (max-width: 768px) {
      .sidebar {
        display: none;
      }

      .mainContent {
        margin-left: 0;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  
  <!-- Day.js -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
  
  <!-- Ant Design JS -->
  <script src="https://cdn.jsdelivr.net/npm/antd@5.12.8/dist/antd.min.js"></script>
  
  <!-- Babel Standalone for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    const { Card, Table, Button, Tag, Space, Select, Typography } = antd;
    const { Title } = Typography;
    const { Option } = Select;

    const MyProjects = () => {
      const [orders, setOrders] = useState([]);
      const [loading, setLoading] = useState(false);
      const [statusFilter, setStatusFilter] = useState('');

      useEffect(() => {
        loadOrders();
      }, []);

      const loadOrders = () => {
        setLoading(true);
        let data = JSON.parse(localStorage.getItem('currentOrders') || '[]');
        if (data.length === 0) {
          data = generateMockOrders();
          localStorage.setItem('currentOrders', JSON.stringify(data));
        }
        
        // ä»è´¢åŠ¡è´¦æœ¬ä¸­è·å–æ‰£æ¬¾ä¿¡æ¯ï¼Œè®¡ç®—å®ä»˜é‡‘é¢
        const financeLedger = JSON.parse(localStorage.getItem('financeLedger') || '[]');
        const ledgerMap = {};
        financeLedger.forEach(item => {
          ledgerMap[item.orderId] = item;
        });
        
        // ä¸ºæ¯ä¸ªè®¢å•æ·»åŠ é¢„ä¼°é‡‘é¢å’Œå®ä»˜é‡‘é¢
        data = data.map(order => {
          const orderId = order.orderId || order.id;
          const ledgerItem = ledgerMap[orderId];
          const estimatedAmount = order.amount || order.unitPrice || 0;
          const deduction = ledgerItem ? (ledgerItem.deduction || 0) : 0;
          const actualAmount = estimatedAmount - deduction;
          
          return {
            ...order,
            estimatedAmount: estimatedAmount,
            actualAmount: actualAmount,
            deduction: deduction,
            isOrder: true, // æ ‡è®°ä¸ºè®¢å•
          };
        });

        // è¯»å–è¢«é©³å›çš„ç”³è¯·
        const applications = JSON.parse(localStorage.getItem('applications') || '[]');
        const rejectedApplications = applications
          .filter(app => 
            app.applicant === 'å½“å‰ç”¨æˆ·' && 
            app.status === 'Rejected'
          )
          .map(app => ({
            id: app.id,
            orderId: null, // ç”³è¯·æ²¡æœ‰è®¢å•å·
            applicationId: app.id,
            projectId: app.projectId,
            projectName: app.projectName,
            takeTime: app.applyTime,
            dueTime: null,
            status: 'Rejected',
            amount: 0,
            estimatedAmount: 0,
            actualAmount: 0,
            deduction: 0,
            isOrder: false, // æ ‡è®°ä¸ºç”³è¯·
            rejectReason: app.rejectReason,
            reviewTime: app.reviewTime,
          }));

        // åˆå¹¶è®¢å•å’Œè¢«é©³å›çš„ç”³è¯·
        data = [...data, ...rejectedApplications];
        
        setOrders(data);
        setLoading(false);
      };

      const generateMockOrders = () => {
        const projects = [
          { id: '1', name: 'éœ¸é“æ€»è£çˆ±ä¸Šæˆ‘', category: 'çŸ­å‰§' },
          { id: '2', name: 'AIæ¼«å‰§ï¼šç©¿è¶Šæ—¶ç©ºçš„å†’é™©', category: 'AIæ¼«å‰§' },
          { id: '3', name: 'çŸ­å‰§ï¼šå¤è£…ä»™ä¾ ä¼ å¥‡', category: 'çŸ­å‰§' },
          { id: '4', name: 'ç»¼è‰ºå‰ªè¾‘ï¼šçœŸäººç§€ç²¾å½©ç‰‡æ®µ', category: 'ç»¼è‰º' },
          { id: '5', name: 'çŸ­è§†é¢‘ï¼šç¾é£Ÿæ¢åº—ç³»åˆ—', category: 'çŸ­è§†é¢‘' },
        ];
        const statuses = ['InProgress', 'Submitted', 'NeedRevision', 'Approved', 'Accepted', 'Closed'];
        return projects.map((p, i) => {
          const status = statuses[i % statuses.length];
          const takeTime = dayjs().subtract(10 - i * 2, 'day').format('YYYY-MM-DD HH:mm:ss');
          const dueTime = dayjs().add(5 + i, 'day').format('YYYY-MM-DD HH:mm:ss');
          const orderId = `ORD${String(i + 1).padStart(6, '0')}`;
          const estimatedAmount = [500, 800, 600, 400, 300][i] * (10 + i * 2);
          return {
            orderId: orderId,
            id: orderId,
            projectId: p.id,
            projectName: p.name,
            category: p.category,
            takeTime: takeTime,
            dueTime: dueTime,
            status: status,
            amount: estimatedAmount,
            estimatedAmount: estimatedAmount,
            actualAmount: estimatedAmount, // åˆå§‹æ—¶å®ä»˜é‡‘é¢ç­‰äºé¢„ä¼°é‡‘é¢
            deduction: 0,
          };
        });
      };

      const filteredOrders = useMemo(() => {
        if (!statusFilter) return orders;
        return orders.filter((o) => o.status === statusFilter);
      }, [orders, statusFilter]);

      const statusMap = {
        'InProgress': { color: 'blue', text: 'è¿›è¡Œä¸­' },
        'Submitted': { color: 'green', text: 'å·²æäº¤' },
        'NeedRevision': { color: 'orange', text: 'é€€å›ä¿®æ”¹' },
        'Approved': { color: 'green', text: 'å®¡æ ¸é€šè¿‡' },
        'Accepted': { color: 'success', text: 'å·²éªŒæ”¶' },
        'Closed': { color: 'default', text: 'å·²å…³é—­' },
        'Rejected': { color: 'red', text: 'å·²é©³å›' },
      };

      const goToSpace = (record) => {
        // æ ¹æ®ä¸šåŠ¡é€»è¾‘ï¼šä¸€ä¸ªé¡¹ç›®IDå¯¹åº”ä¸€ä¸ªé¡¹ç›®ç©ºé—´ï¼Œå¤šä¸ªè®¢å•å…±äº«ä¸€ä¸ªé¡¹ç›®ç©ºé—´
        const pid = record.projectId;
        const oid = record.orderId || record.id;
        
        if (pid) {
          // ä¼˜å…ˆä½¿ç”¨é¡¹ç›®IDè®¿é—®é¡¹ç›®ç©ºé—´
          if (oid) {
            // å¦‚æœæœ‰è®¢å•IDï¼ŒåŒæ—¶ä¼ é€’ï¼ˆç”¨äºå…¼å®¹ï¼‰
            window.location.href = `ProjectSpace.html?projectId=${pid}&orderId=${oid}`;
          } else {
            // åªæœ‰é¡¹ç›®IDä¹Ÿå¯ä»¥è®¿é—®é¡¹ç›®ç©ºé—´
            window.location.href = `ProjectSpace.html?projectId=${pid}`;
          }
        } else if (oid) {
          // å…¼å®¹æ—§ç‰ˆæœ¬ï¼šå¦‚æœæ²¡æœ‰é¡¹ç›®IDï¼Œä½¿ç”¨è®¢å•ID
          window.location.href = `ProjectSpace.html?orderId=${oid}`;
        }
      };

      const columns = [
        {
          title: 'è®¢å•å·/ç”³è¯·å•å·',
          dataIndex: 'orderId',
          key: 'orderId',
          width: 160,
          render: (val, r) => {
            if (r.isOrder === false && r.applicationId) {
              return r.applicationId || '-';
            }
            return val || r.id || '-';
          },
        },
        {
          title: 'é¡¹ç›®åç§°',
          dataIndex: 'projectName',
          key: 'projectName',
          ellipsis: true,
        },
        {
          title: 'æ¥å•æ—¶é—´',
          dataIndex: 'takeTime',
          key: 'takeTime',
          width: 180,
          render: (t) => (t ? dayjs(t).format('YYYY-MM-DD HH:mm:ss') : '-'),
        },
        {
          title: 'æˆªæ­¢æ—¶é—´',
          dataIndex: 'dueTime',
          key: 'dueTime',
          width: 180,
          render: (t) => (t ? dayjs(t).format('YYYY-MM-DD HH:mm:ss') : '-'),
        },
        {
          title: 'çŠ¶æ€',
          dataIndex: 'status',
          key: 'status',
          width: 150,
          render: (status, record) => {
            const c = statusMap[status] || { color: 'default', text: status };
            return (
              <div>
                <Tag color={c.color}>{c.text}</Tag>
                {status === 'Rejected' && record.rejectReason && (
                  <div style={{ marginTop: 4, fontSize: 12, color: '#ff4d4f' }}>
                    é©³å›åŸå› ï¼š{record.rejectReason}
                  </div>
                )}
              </div>
            );
          },
        },
        {
          title: 'è®¢å•é¢„ä¼°é‡‘é¢',
          dataIndex: 'estimatedAmount',
          key: 'estimatedAmount',
          width: 150,
          align: 'right',
          render: (amount) => (
            <span style={{ fontWeight: 500 }}>Â¥{amount ? amount.toLocaleString() : 0}</span>
          ),
        },
        {
          title: 'è®¢å•å®ä»˜é‡‘é¢',
          dataIndex: 'actualAmount',
          key: 'actualAmount',
          width: 150,
          align: 'right',
          render: (amount, record) => {
            const hasDeduction = record.deduction && record.deduction > 0;
            return (
              <span style={{ 
                fontWeight: 500, 
                color: hasDeduction ? '#ff4d4f' : '#52c41a' 
              }}>
                Â¥{amount ? amount.toLocaleString() : 0}
                {hasDeduction && (
                  <span style={{ fontSize: 12, color: '#8c8c8c', marginLeft: 4 }}>
                    (å·²æ‰£Â¥{record.deduction.toLocaleString()})
                  </span>
                )}
              </span>
            );
          },
        },
        {
          title: 'æ“ä½œ',
          key: 'action',
          width: 120,
          render: (_, record) => {
            // è¢«é©³å›çš„ç”³è¯·ä¸æ˜¾ç¤º"è¿›å…¥ç©ºé—´"æŒ‰é’®
            if (record.status === 'Rejected' && record.isOrder === false) {
              return <span style={{ color: '#8c8c8c', fontSize: 12 }}>ç”³è¯·å·²é©³å›</span>;
            }
            return (
              <Button type="primary" size="small" onClick={() => goToSpace(record)}>
                é¡¹ç›®ç©ºé—´
              </Button>
            );
          },
        },
      ];

      return (
        <div className="appLayout">
          <div className="sidebar">
            <div className="sidebarHeader">
              <a href="Home.html" className="logo">ğŸ¬ å¤©åˆçŸ­å‰§å¹³å°</a>
            </div>
            <nav className="menu">
              <a href="Home.html" className="menuItem">
                <span className="menuItemIcon">ğŸ </span>
                é¦–é¡µ
              </a>
              <a href="ProjectHall.html" className="menuItem">
                <span className="menuItemIcon">ğŸ“‹</span>
                æ¥å•å¤§å…
              </a>
              <a href="Leaderboard.html" className="menuItem">
                <span className="menuItemIcon">ğŸ†</span>
                å¤©æ¢¯æ¦œå•
              </a>
              <a href="Account.html" className="menuItem">
                <span className="menuItemIcon">ğŸ’°</span>
                è´¦æˆ·ä¸æ”¶ç›Š
              </a>
              <a href="MyProjects.html" className="menuItem active">
                <span className="menuItemIcon">ğŸš€</span>
                æˆ‘çš„é¡¹ç›®
              </a>
              <div className="menuGroup">
                <div className="menuGroupTitle">åå°ç®¡ç†</div>
                <a href="ReviewQueue.html" className="menuItem">
                  <span className="menuItemIcon">âœ…</span>
                  ä»»åŠ¡å®¡æ ¸
                </a>
                <a href="ProjectManagement.html" className="menuItem">
                  <span className="menuItemIcon">ğŸ“‹</span>
                  é¡¹ç›®ç®¡ç†
                </a>
                <a href="StudentManagement.html" className="menuItem">
                  <span className="menuItemIcon">ğŸ‘¥</span>
                  å­¦å‘˜ç®¡ç†
                </a>
                <a href="FinanceManagement.html" className="menuItem">
                  <span className="menuItemIcon">ğŸ’°</span>
                  è´¢åŠ¡å¯¹è´¦
                </a>
                <a href="DashboardManagement.html" className="menuItem">
                  <span className="menuItemIcon">ğŸ“Š</span>
                  æ¦œå•ä¸æ•°æ®
                </a>
              </div>
            </nav>
          </div>

          <div className="mainContent">
            <div className="myProjectsPage">
              <div className="pageHeader">
                <Title level={2} style={{ margin: 0 }}>æˆ‘çš„é¡¹ç›®</Title>
              </div>

              <div className="filterCard">
                <Space size="middle">
                  <span>çŠ¶æ€ï¼š</span>
                  <Select
                    style={{ width: 140 }}
                    placeholder="å…¨éƒ¨"
                    allowClear
                    value={statusFilter || undefined}
                    onChange={(v) => setStatusFilter(v || '')}
                  >
                    <Option value="InProgress">è¿›è¡Œä¸­</Option>
                    <Option value="Submitted">å·²æäº¤</Option>
                    <Option value="NeedRevision">é€€å›ä¿®æ”¹</Option>
                    <Option value="Approved">å®¡æ ¸é€šè¿‡</Option>
                    <Option value="Accepted">å·²éªŒæ”¶</Option>
                    <Option value="Closed">å·²å…³é—­</Option>
                    <Option value="Rejected">å·²é©³å›</Option>
                  </Select>
                </Space>
              </div>

              <div className="tableCard">
                <Table
                  columns={columns}
                  dataSource={filteredOrders}
                  rowKey={(r) => r.orderId || r.id}
                  loading={loading}
                  scroll={{ x: 1200 }}
                  pagination={{
                    pageSize: 10,
                    showSizeChanger: true,
                    showTotal: (total) => `å…± ${total} æ¡`,
                  }}
                  style={{ padding: '16px 24px' }}
                />
              </div>
            </div>
          </div>
        </div>
      );
    };

    window.addEventListener('load', function () {
      try {
        ReactDOM.render(<MyProjects />, document.getElementById('root'));
      } catch (e) {
        console.error('æ¸²æŸ“é”™è¯¯:', e);
        document.getElementById('root').innerHTML = '<div style="padding:20px;color:red;">é¡µé¢åŠ è½½å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚</div>';
      }
    });
  </script>
</body>
</html>
